{
  "name": "üè† –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –ø–∞–º—è—Ç—å—é (Ollama)",
  "nodes": [
    {
      "parameters": {
        "updates": ["message"]
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [240, 460],
      "credentials": {
        "telegramApi": "YOUR_TELEGRAM_CREDENTIAL"
      }
    },
    {
      "parameters": {
        "jsCode": "const message = $input.item.json.message;\nconst text = message?.text || '';\nconst chatId = message?.chat?.id;\nconst userName = message?.from?.first_name || '–î—Ä—É–≥';\n\nif (!text || !chatId) {\n  return [];\n}\n\nif (text === '/start' || text === '/help') {\n  return [{\n    json: {\n      isCommand: true,\n      chatId: chatId,\n      responseText: `üëã –ü—Ä–∏–≤–µ—Ç, ${userName}!\\n\\nü§ñ –Ø AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —É–º–Ω–æ–≥–æ –¥–æ–º–∞ –Ω–∞ Ollama (llama3.1:8b)\\n\\n*–ß—Ç–æ —è —É–º–µ—é:*\\n‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –¥–æ–º–µ\\n‚Ä¢ –ü–æ–º–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞\\n‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—á–∏–∫–∏\\n\\n*–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:*\\n‚Ä¢ \"–ö–∞–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞?\"\\n‚Ä¢ \"–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –¥–∞—Ç—á–∏–∫–∏?\"\\n‚Ä¢ \"–ê –≤ —Å–ø–∞–ª—å–Ω–µ?\" (–ø–æ–º–Ω—é –∫–æ–Ω—Ç–µ–∫—Å—Ç!)\\n\\n*–ö–æ–º–∞–Ω–¥—ã:*\\n/clear - –æ—á–∏—Å—Ç–∏—Ç—å –ø–∞–º—è—Ç—å –¥–∏–∞–ª–æ–≥–∞`\n    }\n  }];\n}\n\nif (text === '/clear') {\n  return [{\n    json: {\n      isCommand: true,\n      chatId: chatId,\n      responseText: 'üóëÔ∏è –ü–∞–º—è—Ç—å –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞! –ù–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞.'\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    isCommand: false,\n    chatId: chatId,\n    userName: userName,\n    userMessage: text\n  }\n}];"
      },
      "id": "process-message",
      "name": "Process Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 460]
    },
    {
      "parameters": {
        "conditions": {
          "options": {"typeValidation": "strict"},
          "conditions": [
            {
              "leftValue": "={{ $json.isCommand ? 'command' : 'chat' }}",
              "rightValue": "command",
              "operator": {"type": "string", "operation": "equals"}
            }
          ],
          "combinator": "and"
        }
      },
      "id": "is-command",
      "name": "Is Command?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [680, 460]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.responseText }}",
        "additionalFields": {"parse_mode": "Markdown"}
      },
      "id": "send-command",
      "name": "Send Command Response",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [900, 340],
      "credentials": {
        "telegramApi": "YOUR_TELEGRAM_CREDENTIAL"
      }
    },
    {
      "parameters": {
        "resource": "state",
        "operation": "getAll"
      },
      "id": "get-ha-states",
      "name": "Get HA States",
      "type": "n8n-nodes-base.homeAssistant",
      "typeVersion": 1,
      "position": [900, 580],
      "credentials": {
        "homeAssistantApi": "YOUR_HA_CREDENTIAL"
      }
    },
    {
      "parameters": {
        "jsCode": "const processData = $('Process Message').item.json;\nconst userMessage = processData.userMessage;\nconst chatId = processData.chatId;\nconst userName = processData.userName;\n\nconst haItems = $input.all();\nlet allStates = [];\n\nfor (const item of haItems) {\n  if (Array.isArray(item.json)) {\n    allStates = allStates.concat(item.json);\n  } else if (item.json.entity_id) {\n    allStates.push(item.json);\n  }\n}\n\nif (allStates.length === 0) {\n  return [{\n    json: {\n      userMessage: userMessage,\n      chatId: chatId,\n      userName: userName,\n      devicesContext: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç Home Assistant',\n      totalDevices: 0,\n      currentTime: new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })\n    }\n  }];\n}\n\nconst relevantDomains = ['sensor', 'binary_sensor', 'climate', 'light', 'switch', 'weather', 'person'];\n\nconst filtered = allStates.filter(state => {\n  const domain = state.entity_id?.split('.')[0];\n  return domain && relevantDomains.includes(domain) && \n         state.state !== 'unavailable' && \n         state.state !== 'unknown';\n});\n\nconst devicesList = filtered.slice(0, 40).map(state => {\n  const name = state.attributes?.friendly_name || state.entity_id;\n  const value = state.state;\n  const unit = state.attributes?.unit_of_measurement || '';\n  return `${name}: ${value}${unit ? ' ' + unit : ''}`;\n}).join('\\n');\n\nreturn [{\n  json: {\n    userMessage: userMessage,\n    chatId: chatId,\n    userName: userName,\n    devicesContext: devicesList || '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤',\n    totalDevices: filtered.length,\n    currentTime: new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })\n  }\n}];"
      },
      "id": "prepare-context",
      "name": "Prepare AI Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 580]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Prepare AI Context').item.json.userMessage }}",
        "options": {
          "systemMessage": "–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —É–º–Ω–æ–≥–æ –¥–æ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ $('Prepare AI Context').item.json.userName }}.\n\nüìÖ –¢–ï–ö–£–©–ï–ï –í–†–ï–ú–Ø: {{ $('Prepare AI Context').item.json.currentTime }}\n\nüè† –î–û–°–¢–£–ü–ù–´–ï –£–°–¢–†–û–ô–°–¢–í–ê ({{ $('Prepare AI Context').item.json.totalDevices }}):\n{{ $('Prepare AI Context').item.json.devicesContext }}\n\nüìã –¢–í–û–ò –ü–†–ê–í–ò–õ–ê:\n1. –û—Ç–≤–µ—á–∞–π –ö–†–ê–¢–ö–û –∏ –ü–û –î–ï–õ–£ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ\n2. –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–æ–º–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ\n3. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ - –∏—â–∏ –µ–≥–æ –≤ —Å–ø–∏—Å–∫–µ\n4. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º\n5. –ü–æ–º–Ω–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–µ\n6. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ (üå°Ô∏è üè† üí° ‚ö° üå§Ô∏è)\n7. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ - —Ç–æ–ª—å–∫–æ —Ç–æ —á—Ç–æ –≤–∏–¥–∏—à—å\n\nüí¨ –ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–¢–í–ï–¢–û–í:\n- \"–ö–∞–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞?\" ‚Üí \"üå°Ô∏è –°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –¥–æ–º–µ 21¬∞C. –ì–æ—Å—Ç–∏–Ω–∞—è: 22¬∞C, –°–ø–∞–ª—å–Ω—è: 20¬∞C, –ö—É—Ö–Ω—è: 21¬∞C\"\n- \"–ê –≤ –≤–∞–Ω–Ω–æ–π?\" ‚Üí \"üå°Ô∏è –í –≤–∞–Ω–Ω–æ–π 23¬∞C\" (–∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —á—Ç–æ —Ä–µ—á—å –æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ)\n- \"–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ?\" ‚Üí \"üí° –í–∫–ª—é—á–µ–Ω–æ: –°–≤–µ—Ç –≤ –≥–æ—Å—Ç–∏–Ω–æ–π, –°–≤–µ—Ç –Ω–∞ –∫—É—Ö–Ω–µ. –í—ã–∫–ª—é—á–µ–Ω–æ –æ—Å—Ç–∞–ª—å–Ω–æ–µ.\""
        }
      },
      "id": "ai-agent",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [1340, 580]
    },
    {
      "parameters": {
        "model": "llama3.1:8b",
        "options": {
          "baseURL": "http://YOUR_OLLAMA_IP:11434",
          "temperature": 0.7
        }
      },
      "id": "ollama-model",
      "name": "Ollama Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [1560, 700]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Prepare AI Context').item.json.chatId }}",
        "contextWindowLength": 10
      },
      "id": "memory-buffer",
      "name": "Memory Buffer",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [1560, 820]
    },
    {
      "parameters": {
        "jsCode": "const agentResponse = $input.item.json;\nconst chatId = $('Prepare AI Context').item.json.chatId;\n\nlet responseText = '';\n\nif (agentResponse.output) {\n  responseText = agentResponse.output;\n} else if (agentResponse.text) {\n  responseText = agentResponse.text;\n} else if (typeof agentResponse === 'string') {\n  responseText = agentResponse;\n} else {\n  responseText = '‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI';\n}\n\nreturn [{\n  json: {\n    chatId: chatId,\n    responseText: responseText\n  }\n}];"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 580]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.responseText }}"
      },
      "id": "send-response",
      "name": "Send AI Response",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1780, 580],
      "credentials": {
        "telegramApi": "YOUR_TELEGRAM_CREDENTIAL"
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {"main": [[{"node": "Process Message", "type": "main", "index": 0}]]},
    "Process Message": {"main": [[{"node": "Is Command?", "type": "main", "index": 0}]]},
    "Is Command?": {"main": [[{"node": "Send Command Response", "type": "main", "index": 0}],[{"node": "Get HA States", "type": "main", "index": 0}]]},
    "Get HA States": {"main": [[{"node": "Prepare AI Context", "type": "main", "index": 0}]]},
    "Prepare AI Context": {"main": [[{"node": "AI Agent", "type": "main", "index": 0}]]},
    "Ollama Model": {"ai_languageModel": [[{"node": "AI Agent", "type": "ai_languageModel", "index": 0}]]},
    "Memory Buffer": {"ai_memory": [[{"node": "AI Agent", "type": "ai_memory", "index": 0}]]},
    "AI Agent": {"main": [[{"node": "Format Response", "type": "main", "index": 0}]]},
    "Format Response": {"main": [[{"node": "Send AI Response", "type": "main", "index": 0}]]}
  },
  "settings": {"executionOrder": "v1"},
  "tags": []
}
