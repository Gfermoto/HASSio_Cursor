# Ollama –Ω–∞ Proxmox —Å NVIDIA GPU - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é Ollama –≤ Ubuntu VM –Ω–∞ Proxmox —Å GPU passthrough.
–ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä—É–µ—Ç community best practices –∏ –≥–ª—É–±–æ–∫–∏–µ –∑–Ω–∞–Ω–∏—è Proxmox.

**–¶–µ–ª–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- Proxmox VE 8.x (Debian 12 Bookworm)
- NVIDIA GTX 1050 Ti (4GB VRAM) ‚Üí GTX 1060 (6GB VRAM)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –º–∞–π–Ω–∏–Ω–≥–æ–≤—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏ (P106, P104, CMP)
- Ubuntu 22.04 LTS VM
- Ollama —Å –º–æ–¥–µ–ª—è–º–∏ phi3:mini / llama3.1:8b

**–í—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:** 40-60 –º–∏–Ω—É—Ç
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** Intermediate
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ Proxmox —Ö–æ—Å—Ç –æ—Å—Ç–∞–µ—Ç—Å—è —á–∏—Å—Ç—ã–º

---

## –ü–æ—á–µ–º—É VM, –∞ –Ω–µ LXC?

**–ü—Ä–æ–±–ª–µ–º–∞ —Å LXC:**
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ `nvidia-driver` –Ω–∞ Proxmox —Ö–æ—Å—Ç –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å `proxmox-ve` metapackage:
```text
W: You are attempting to remove the meta-package 'proxmox-ve'!
E: Sub-process /usr/share/proxmox-ve/pve-apt-hook returned an error code (1)
```

**–†–µ—à–µ–Ω–∏–µ - VM —Å PCI passthrough:**
- ‚úÖ NVIDIA –¥—Ä–∞–π–≤–µ—Ä—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –≤ VM**, –Ω–µ –Ω–∞ —Ö–æ—Å—Ç–µ
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å proxmox-ve
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –æ—Ç Proxmox
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ Ubuntu (–±–µ–∑ –ø—Ä–æ–±–ª–µ–º)
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç IOMMU/VT-d –≤ BIOS
- ‚ö†Ô∏è GPU –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–π VM
- ‚ö†Ô∏è Overhead ~5-10% (–ø—Ä–∏–µ–º–ª–µ–º–æ)

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
- [Habr: –ü—Ä–æ–±—Ä–æ—Å –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã –≤ Proxmox](https://habr.com/ru/articles/794568/)
- [Proxmox Wiki: PCI Passthrough](https://pve.proxmox.com/wiki/PCI_Passthrough)
- [Proxmox Forum: Ollama + GPU](https://forum.proxmox.com/threads/ubuntu-22-04-ollama-nvidia-3060-gpu-passthrough-and-drivers-all-looking-good-but.144104/)

---

## –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ BIOS/UEFI (–Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–µ)

### 1.1 –í–∫–ª—é—á–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏

–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –∏ –≤–æ–π–¥–∏—Ç–µ –≤ BIOS/UEFI (–æ–±—ã—á–Ω–æ Del, F2, F10 –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ).

–ù–∞–π–¥–∏—Ç–µ –∏ –≤–∫–ª—é—á–∏—Ç–µ:

**–î–ª—è Intel –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏—Ö –ø–ª–∞—Ç:**
- **Intel VT-x** (Virtualization Technology) ‚Üí Enabled
- **Intel VT-d** (Virtualization Technology for Directed I/O) ‚Üí Enabled
- **IOMMU** ‚Üí Enabled (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–∞—è –æ–ø—Ü–∏—è)

**–î–ª—è AMD –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏—Ö –ø–ª–∞—Ç:**
- **SVM Mode** (AMD-V) ‚Üí Enabled
- **AMD-Vi** (AMD IOMMU) ‚Üí Enabled
- **IOMMU** ‚Üí Enabled

**–ì–¥–µ –∏—Å–∫–∞—Ç—å:** –û–±—ã—á–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–∞—Ö:
- Advanced ‚Üí CPU Configuration
- Chipset Configuration
- Virtualization Support

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ (F10) –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ.

### 1.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ BIOS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ Proxmox:

```bash
ssh root@<PROXMOX_IP>

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏
egrep -o '(vmx|svm)' /proc/cpuinfo | uniq

# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏: vmx (Intel) –∏–ª–∏ svm (AMD)
# –ï—Å–ª–∏ –ø—É—Å—Ç–æ - VT-x/AMD-V –Ω–µ –≤–∫–ª—é—á–µ–Ω –≤ BIOS
```

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ IOMMU –≤ —Å–∏—Å—Ç–µ–º–µ
dmesg | grep -e DMAR -e IOMMU

# –î–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å (Intel):
# DMAR: IOMMU enabled
# DMAR-IR: Enabled IRQ remapping

# –ò–ª–∏ (AMD):
# AMD-Vi: Found IOMMU
# AMD-Vi: Interrupt remapping enabled
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** –í–∏–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± IOMMU/DMAR.
**–ï—Å–ª–∏ –Ω–µ—Ç (AMD):** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –Ω–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ - IOMMU –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GRUB (–≠—Ç–∞–ø 2). –ì–ª–∞–≤–Ω–æ–µ —á—Ç–æ–±—ã `svm` –±—ã–ª –≤–∏–¥–µ–Ω.

### 1.3 –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ –¥–ª—è ASRock –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏—Ö –ø–ª–∞—Ç (–≤–∞–∂–Ω–æ!)

–ï—Å–ª–∏ —É –≤–∞—Å **ASRock** (–Ω–∞–ø—Ä–∏–º–µ—Ä B450M Pro4, X570 –∏ —Ç.–¥.) –∏ –≤—ã **–Ω–µ –≤–∏–¥–∏—Ç–µ –æ–ø—Ü–∏—é IOMMU –≤ BIOS**:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é BIOS:**
   - –í–æ–π–¥–∏—Ç–µ –≤ BIOS –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é (–æ–±—ã—á–Ω–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ)
   - –î–ª—è B450M Pro4: —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ (P3.xx) –º–æ–≥—É—Ç –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å IOMMU

2. **–û–±–Ω–æ–≤–∏—Ç–µ BIOS –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏:**
   - –°–∫–∞—á–∞–π—Ç–µ —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ ASRock: https://www.asrock.com/support/
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **Instant Flash** –≤ BIOS (Tools ‚Üí Instant Flash)
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª .ROM –Ω–∞ USB —Ñ–ª–µ—à–∫—É FAT32
   - –í –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö (P7.xx+) –æ–ø—Ü–∏—è IOMMU –ø–æ—è–≤–ª—è–µ—Ç—Å—è

3. **–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è BIOS –∏—â–∏—Ç–µ:**
   - `Advanced ‚Üí AMD CBS ‚Üí IOMMU ‚Üí Enabled`

   –ò–ª–∏:
   - `Advanced ‚Üí AMD CBS ‚Üí NBIO Common Options ‚Üí IOMMU ‚Üí Enabled`

4. **–¢–∞–∫–∂–µ –≤–∫–ª—é—á–∏—Ç–µ:**
   - SVM Mode ‚Üí Enabled (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ)

**‚ö†Ô∏è –í–∞–∂–Ω–æ:** –ë–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è BIOS –æ–ø—Ü–∏—è IOMMU –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç–∞ –¥–∞–∂–µ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ!

---

## –≠—Ç–∞–ø 2: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Proxmox —Ö–æ—Å—Ç–∞ –¥–ª—è IOMMU

### 2.1 –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GRUB

```bash
# Backup —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp /etc/default/grub /etc/default/grub.backup

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
nano /etc/default/grub
```

–ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –Ω–∞—á–∏–Ω–∞—é—â—É—é—Å—è —Å `GRUB_CMDLINE_LINUX_DEFAULT=`

**–î–ª—è Intel –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤:**

–ë—ã–ª–æ:
```text
GRUB_CMDLINE_LINUX_DEFAULT="quiet"
```

–°—Ç–∞–Ω–µ—Ç:
```text
GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on iommu=pt"
```

**–î–ª—è AMD –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤:**

```text
GRUB_CMDLINE_LINUX_DEFAULT="quiet amd_iommu=on iommu=pt"
```

**‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è AMD:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–º–µ–Ω–Ω–æ `amd_iommu=on`, –∞ –Ω–µ `amd_iommu=1` –∏–ª–∏ `amd_iommu=force_enable`. –í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —è–¥—Ä–∞—Ö (6.8+) —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ `=on`. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "AMD-Vi: Unknown option - 'on'" - –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ –µ–≥–æ, AMD-Vi –≤—Å–µ —Ä–∞–≤–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `intel_iommu=on` / `amd_iommu=on` - –≤–∫–ª—é—á–µ–Ω–∏–µ IOMMU
- `iommu=pt` - passthrough mode (–ª—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ: Ctrl+O, Enter, Ctrl+X

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ GRUB:

```bash
update-grub

# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
# Generating grub configuration file ...
# Found linux image: /boot/vmlinuz-6.8.12-4-pve
# done
```

### 2.2 –ó–∞–≥—Ä—É–∑–∫–∞ VFIO –º–æ–¥—É–ª–µ–π

VFIO (Virtual Function I/O) - framework –¥–ª—è –ø—Ä–æ–±—Ä–æ—Å–∞ PCI —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ VM.

```bash
nano /etc/modules
```

–î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞:

```text
vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ: Ctrl+O, Enter, Ctrl+X

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π:**
- `vfio` - –æ—Å–Ω–æ–≤–Ω–æ–π framework
- `vfio_iommu_type1` - IOMMU backend
- `vfio_pci` - PCI device support
- `vfio_virqfd` - interrupt remapping

### 2.3 –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ initramfs
update-initramfs -u -k all

# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
# update-initramfs: Generating /boot/initrd.img-6.8.12-4-pve
```

### 2.4 –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ö–æ—Å—Ç–∞

```bash
reboot
```

–ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 –º–∏–Ω—É—Ç—ã –ø–æ–∫–∞ Proxmox –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è.

### 2.5 –ü—Ä–æ–≤–µ—Ä–∫–∞ IOMMU –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

```bash
ssh root@<PROXMOX_IP>

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ IOMMU –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
dmesg | grep -i "IOMMU enabled"

# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
# DMAR: IOMMU enabled (Intel)
# –∏–ª–∏
# AMD-Vi: AMD IOMMUv2 loaded and initialized
```

**–î–ª—è AMD: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ IVRS**

–ï—Å–ª–∏ AMD-Vi –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ BIOS –ø–µ—Ä–µ–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É IVRS:

```bash
dmesg | grep -i ivrs

# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
# ACPI: IVRS 0x... (–µ—Å–ª–∏ –µ—Å—Ç—å - BIOS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
# –ï—Å–ª–∏ –ø—É—Å—Ç–æ - –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ BIOS, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ IOMMU = Enabled
```

```bash
# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ IOMMU –≥—Ä—É–ø–ø (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
ls /sys/kernel/iommu_groups/ | wc -l

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0 (–æ–±—ã—á–Ω–æ 10-30 –≥—Ä—É–ø–ø)
# –ï—Å–ª–∏ 0 - AMD-Vi –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
```

```bash
# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ AMD-Vi –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
dmesg | grep -i amd-vi

# –î–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
# AMD-Vi: Interrupt remapping enabled
# AMD-Vi: Virtual APIC enabled
# (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "Unknown option" - –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ –µ–≥–æ)
```

```bash
# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ VFIO –º–æ–¥—É–ª–µ–π
lsmod | grep vfio

# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
# vfio_pci
# vfio_iommu_type1
# vfio
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:**
- ‚úÖ IOMMU groups > 0
- ‚úÖ AMD-Vi: Interrupt remapping enabled
- ‚úÖ VFIO –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã

**–ï—Å–ª–∏ IOMMU groups = 0:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `dmesg | grep -i ivrs` - –µ—Å–ª–∏ –ø—É—Å—Ç–æ, IOMMU –Ω–µ –≤–∫–ª—é—á–µ–Ω –≤ BIOS
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `/proc/cmdline` - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `iommu=pt`
3. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≠—Ç–∞–ø 1 (BIOS) –∏ 2.1-2.4

---

## –≠—Ç–∞–ø 3: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ GPU –¥–ª—è passthrough

### 3.1 –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ GPU –≤ —Å–∏—Å—Ç–µ–º–µ

```bash
lspci -nn | grep -i nvidia
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –¥–ª—è GTX 1050 Ti:**
```text
01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GP107 [GeForce GTX 1050 Ti] [10de:1c82] (rev a1)
01:00.1 Audio device [0403]: NVIDIA Corporation GP107GL High Definition Audio Controller [10de:0fb9] (rev a1)
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –¥–ª—è P106-100 (–º–∞–π–Ω–∏–Ω–≥–æ–≤–∞—è –∫–∞—Ä—Ç–∞):**
```text
06:00.0 3D controller [0302]: NVIDIA Corporation GP106 [P106-100] [10de:1c07] (rev a1)
```

**–ó–∞–ø–∏—à–∏—Ç–µ:**
- PCI Bus –∞–¥—Ä–µ—Å: `01:00.0` (GPU), `01:00.1` (Audio, –µ—Å–ª–∏ –µ—Å—Ç—å)
- Vendor:Device ID: `10de:1c82` (GPU), `10de:0fb9` (Audio, –µ—Å–ª–∏ –µ—Å—Ç—å)

**‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è –º–∞–π–Ω–∏–Ω–≥–æ–≤—ã—Ö –∫–∞—Ä—Ç (P106, P104, CMP):**
- –£ –Ω–∏—Ö **–ù–ï–¢ Audio –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞** (01:00.1)
- –£ –Ω–∏—Ö **–ù–ï–¢ –≤–∏–¥–µ–æ–≤—ã—Ö–æ–¥–æ–≤** (HDMI/DisplayPort)
- –≠—Ç–æ **–Ω–æ—Ä–º–∞–ª—å–Ω–æ** - –æ–Ω–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞—é—Ç –¥–ª—è compute –∑–∞–¥–∞—á (Ollama, CUDA)
- –í vfio.conf —É–∫–∞–∑—ã–≤–∞–π—Ç–µ **—Ç–æ–ª—å–∫–æ GPU ID** –±–µ–∑ Audio

**–í–∞–∂–Ω–æ:** –í–∞—à–∏ ID –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –∫–∞—Ä—Ç—ã (Asus, MSI, Gigabyte).

### 3.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ IOMMU –≥—Ä—É–ø–ø—ã

```bash
#!/bin/bash
for d in /sys/kernel/iommu_groups/*/devices/*; do
    n=${d#*/iommu_groups/*}
    n=${n%%/*}
    printf 'IOMMU Group %s: ' "$n"
    lspci -nns "${d##*/}"
done | grep -i nvidia
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```text
IOMMU Group 1: 01:00.0 VGA compatible controller [0300]: NVIDIA Corporation [10de:1c82]
IOMMU Group 1: 01:00.1 Audio device [0403]: NVIDIA Corporation [10de:0fb9]
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** GPU (01:00.0) –∏ Audio (01:00.1) –≤ **–æ–¥–Ω–æ–π** IOMMU –≥—Ä—É–ø–ø–µ.

**–ï—Å–ª–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö:** –ú–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –Ω–æ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ. –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è ACS override patch (—Å–ª–æ–∂–Ω–æ).

### 3.3 Blacklist NVIDIA –¥—Ä–∞–π–≤–µ—Ä–æ–≤ –Ω–∞ —Ö–æ—Å—Ç–µ

–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ - —Ö–æ—Å—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å GPU, —Ç–æ–ª—å–∫–æ VFIO.

```bash
cat > /etc/modprobe.d/blacklist-nvidia.conf << 'EOF'
blacklist nouveau
blacklist nvidia
blacklist nvidiafb
EOF
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `nouveau` - –æ—Ç–∫—Ä—ã—Ç—ã–π –¥—Ä–∞–π–≤–µ—Ä NVIDIA (–±–ª–æ–∫–∏—Ä—É–µ–º)
- `nvidia` - –ø—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä (–±–ª–æ–∫–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª)
- `nvidiafb` - framebuffer driver

### 3.4 –ü—Ä–∏–≤—è–∑–∫–∞ GPU –∫ VFIO

**–î–ª—è –æ–±—ã—á–Ω—ã—Ö GTX/RTX –∫–∞—Ä—Ç (—Å Audio):**
```bash
echo "options vfio-pci ids=10de:1c82,10de:0fb9" > /etc/modprobe.d/vfio.conf
```

**–î–ª—è –º–∞–π–Ω–∏–Ω–≥–æ–≤—ã—Ö –∫–∞—Ä—Ç (P106, P104, –±–µ–∑ Audio):**
```bash
echo "options vfio-pci ids=10de:1c07" > /etc/modprobe.d/vfio.conf
```

**–ó–∞–º–µ–Ω–∏—Ç–µ** –Ω–∞ –≤–∞—à–∏ ID –∏–∑ —à–∞–≥–∞ 3.1:
- –ï—Å–ª–∏ —É –≤–∞—Å **–¥–≤–∞** —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (GPU + Audio): —É–∫–∞–∂–∏—Ç–µ –æ–±–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
- –ï—Å–ª–∏ **–æ–¥–Ω–æ** —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–º–∞–π–Ω–∏–Ω–≥–æ–≤–∞—è –∫–∞—Ä—Ç–∞): —É–∫–∞–∂–∏—Ç–µ —Ç–æ–ª—å–∫–æ GPU ID

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã VFIO –∑–∞—Ö–≤–∞—Ç–∏—Ç —ç—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ **–¥–æ** –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–≥–∏—Ö –¥—Ä–∞–π–≤–µ—Ä–æ–≤.

### 3.5 –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
update-initramfs -u -k all
reboot
```

### 3.6 –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ GPU binding

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:

```bash
ssh root@<PROXMOX_IP>

lspci -nnk | grep -A 3 -i nvidia
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥ –¥–ª—è GTX/RTX (—Å Audio):**
```text
01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GP107 [GeForce GTX 1050 Ti] [10de:1c82]
        Subsystem: Micro-Star International Co., Ltd. [MSI] [1462:8c96]
        Kernel driver in use: vfio-pci
        Kernel modules: nouveau

01:00.1 Audio device [0403]: NVIDIA Corporation GP107GL [10de:0fb9]
        Subsystem: Micro-Star International Co., Ltd. [MSI] [1462:8c96]
        Kernel driver in use: vfio-pci
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –º–∞–π–Ω–∏–Ω–≥–æ–≤—ã—Ö –∫–∞—Ä—Ç (P106, P104):**
```text
06:00.0 3D controller [0302]: NVIDIA Corporation GP106 [P106-100] [10de:1c07] (rev a1)
        Subsystem: ASUSTeK Computer Inc. GP106 [P106-100] [1043:85fc]
        Kernel driver in use: vfio-pci
        Kernel modules: nvidiafb, nouveau
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** `Kernel driver in use: vfio-pci` –¥–ª—è GPU (–∏ Audio, –µ—Å–ª–∏ –µ—Å—Ç—å).

**–ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `nouveau` –∏–ª–∏ –Ω–µ—Ç driver:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ vfio.conf
cat /etc/modprobe.d/vfio.conf

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
lsmod | grep vfio_pci

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ initramfs
update-initramfs -u -k all
reboot
```

---

## –≠—Ç–∞–ø 4: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Ubuntu Server ISO

```bash
cd /var/lib/vz/template/iso

# Ubuntu 22.04.5 LTS (–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
wget https://releases.ubuntu.com/22.04.5/ubuntu-22.04.5-live-server-amd64.iso

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
wget https://releases.ubuntu.com/22.04.5/SHA256SUMS
sha256sum -c SHA256SUMS 2>&1 | grep ubuntu-22.04.5-live-server-amd64.iso

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
ls -lh ubuntu-22.04.5-live-server-amd64.iso
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: ~2.5-2.7GB
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** ISO —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ `/var/lib/vz/template/iso/`

---

## –≠—Ç–∞–ø 4.5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–∞–º—è—Ç–∏ –Ω–∞ —Ö–æ—Å—Ç–µ (–∫—Ä–∏—Ç–∏—á–Ω–æ!)

**–ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º VM –ø—Ä–æ–≤–µ—Ä—å—Ç–µ RAM –Ω–∞ Proxmox —Ö–æ—Å—Ç–µ:**

```bash
free -h
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```text
              total        used        free      shared  buff/cache   available
Mem:           15Gi        2.0Gi        12Gi        10Mi         1.2Gi        13Gi
```

### üìä –†–∞—Å—á–µ—Ç RAM –¥–ª—è VM:

**–§–æ—Ä–º—É–ª–∞:** `RAM –¥–ª—è VM = Total RAM —Ö–æ—Å—Ç–∞ - 2GB (–¥–ª—è Proxmox) - –∑–∞–ø–∞—Å 1GB`

**–ü—Ä–∏–º–µ—Ä—ã:**
- **16GB —Ö–æ—Å—Ç:** VM –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –¥–æ 13GB (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 10-12GB)
- **8GB —Ö–æ—Å—Ç:** VM –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –¥–æ 5GB (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 4-6GB) ‚ö†Ô∏è
- **32GB —Ö–æ—Å—Ç:** VM –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –¥–æ 29GB (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 16-24GB)

### ‚ö†Ô∏è –î–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞:

**–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–µ:**
- **RAM —Ö–æ—Å—Ç–∞:** 8GB –º–∏–Ω–∏–º—É–º
- **RAM VM:** 8GB (–¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Ollama)

**–ï—Å–ª–∏ —É –≤–∞—Å –º–µ–Ω—å—à–µ 10GB –Ω–∞ —Ö–æ—Å—Ç–µ:**
- –£–º–µ–Ω—å—à–∏—Ç–µ RAM VM –¥–æ 4-6GB
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–µ–±–æ–ª—å—à–∏–µ –º–æ–¥–µ–ª–∏ (phi3:mini, llama3.2:3b)
- –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏—è RAM —Ö–æ—Å—Ç–∞

**–ù–∞—à –ø—Ä–∏–º–µ—Ä (AMD Ryzen 5 2600 + 8GB):**
- **–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** 7.7GB RAM ‚Üí VM —Å 6GB RAM
- **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 16GB RAM ‚Üí VM —Å 10-12GB RAM
- **–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** –°–º–æ–∂–µ–º –∑–∞–ø—É—Å–∫–∞—Ç—å –º–æ–¥–µ–ª–∏ –¥–æ llama3.1:8b

### üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:
–í –¥–∞–Ω–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ö–æ—Å—Ç —Å 8GB RAM (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞). VM –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ 6GB RAM —Å –º–æ–¥–µ–ª—å—é phi3:mini (2.3GB). **–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ RAM —Ö–æ—Å—Ç–∞ –¥–æ 16GB** –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞ –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π (llama3.1:8b, qwen2.5:7b).

---

## –≠—Ç–∞–ø 5: –°–æ–∑–¥–∞–Ω–∏–µ VM —á–µ—Ä–µ–∑ Proxmox Web UI

### 5.1 –ó–∞–ø—É—Å–∫ –º–∞—Å—Ç–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω–∏—è VM

Proxmox Web UI ‚Üí –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª ‚Üí **Create VM**

### 5.2 General (–≤–∫–ª–∞–¥–∫–∞ 1)

- **Node:** –≤–∞—à Proxmox node
- **VM ID:** `300` (–∏–ª–∏ –ª—é–±–æ–π —Å–≤–æ–±–æ–¥–Ω—ã–π, –∑–∞–ø–æ–º–Ω–∏—Ç–µ –µ–≥–æ)
- **Name:** `ollama-vm`
- **Resource Pool:** (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º)
- **Start at boot:** ‚úÖ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ù–∞–∂–º–∏—Ç–µ **Next**

### 5.3 OS (–≤–∫–ª–∞–¥–∫–∞ 2)

- **Use CD/DVD disc image file (ISO)**
- **Storage:** `local`
- **ISO image:** `ubuntu-22.04.5-live-server-amd64.iso`
- **Type:** `Linux`
- **Version:** `6.x - 2.6 Kernel`

–ù–∞–∂–º–∏—Ç–µ **Next**

### 5.4 System (–≤–∫–ª–∞–¥–∫–∞ 3) - –ö–†–ò–¢–ò–ß–ù–û!

- **Graphic card:** `Default`
- **Machine:** `q35` ‚Üê **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è PCIe passthrough**
- **BIOS:** `OVMF (UEFI)` ‚Üê **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è GPU**
- **Add EFI Disk:** ‚úÖ Yes
- **EFI Storage:** `local-lvm`
- **Pre-Enroll keys:** ‚ùå No (–æ—Ç–∫–ª—é—á–∏—Ç–µ Secure Boot)
- **SCSI Controller:** `VirtIO SCSI single`
- **Qemu Agent:** ‚úÖ Yes (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ)

**–ü–æ—á–µ–º—É q35 –∏ OVMF:**
- q35 - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è machine type —Å PCIe support
- OVMF (UEFI) - —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ GPU passthrough
- Secure Boot –æ—Ç–∫–ª—é—á–µ–Ω - NVIDIA –¥—Ä–∞–π–≤–µ—Ä—ã unsigned

–ù–∞–∂–º–∏—Ç–µ **Next**

### 5.5 Disks (–≤–∫–ª–∞–¥–∫–∞ 4)

- **Bus/Device:** `VirtIO Block 0`
- **Storage:** `local-lvm` (–∏–ª–∏ –≤–∞—à–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
- **Disk size (GiB):** `50`
- **Cache:** `Default (No cache)`
- **Discard:** ‚úÖ (–µ—Å–ª–∏ SSD)
- **SSD emulation:** ‚úÖ (–µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞ SSD)

–ù–∞–∂–º–∏—Ç–µ **Next**

### 5.6 CPU (–≤–∫–ª–∞–¥–∫–∞ 5) - –ö–†–ò–¢–ò–ß–ù–û!

- **Sockets:** `1`
- **Cores:** `4` (–º–∏–Ω–∏–º—É–º 2, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 4)
- **Type:** `host` ‚Üê **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è GPU –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
- **Extra CPU Flags:** (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º)

**–ü–æ—á–µ–º—É host:**
- –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ —Ö–æ—Å—Ç–∞ –≤ VM
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è CUDA –∏ GPU compute
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–ù–∞–∂–º–∏—Ç–µ **Next**

### 5.7 Memory (–≤–∫–ª–∞–¥–∫–∞ 6)

‚ö†Ô∏è **–í—ã–±–µ—Ä–∏—Ç–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç RAM —Ö–æ—Å—Ç–∞ (—Å–º. –≠—Ç–∞–ø 4.5):**

**–ï—Å–ª–∏ RAM —Ö–æ—Å—Ç–∞ >= 16GB:**
- **Memory (MiB):** `8192` (8GB, –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è Ollama)
- **Minimum memory (MiB):** `8192`

**–ï—Å–ª–∏ RAM —Ö–æ—Å—Ç–∞ 8-10GB:**
- **Memory (MiB):** `6144` (6GB, –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π)
- **Minimum memory (MiB):** `6144`

**–ï—Å–ª–∏ RAM —Ö–æ—Å—Ç–∞ >= 32GB:**
- **Memory (MiB):** `12288` (12GB, –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π 8B+)
- **Minimum memory (MiB):** `12288`

- **Ballooning Device:** ‚ùå Uncheck (–æ—Ç–∫–ª—é—á–∏—Ç–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í –Ω–∞—à–µ–º –ø—Ä–∏–º–µ—Ä–µ (8GB —Ö–æ—Å—Ç) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 6GB –¥–ª—è VM.

–ù–∞–∂–º–∏—Ç–µ **Next**

### 5.8 Network (–≤–∫–ª–∞–¥–∫–∞ 7)

- **Bridge:** `vmbr0` (–≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π bridge)
- **VLAN Tag:** (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º)
- **Model:** `VirtIO (paravirtualized)`
- **MAC address:** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- **Firewall:** ‚úÖ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ù–∞–∂–º–∏—Ç–µ **Next**

### 5.9 Confirm (–≤–∫–ª–∞–¥–∫–∞ 8)

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- Machine: q35
- BIOS: OVMF
- CPU Type: host
- Memory: 8192 MB

‚úÖ **Start after created** - —Å–Ω–∏–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É! (–Ω–∞—Å—Ç—Ä–æ–∏–º GPU —Å–Ω–∞—á–∞–ª–∞)

–ù–∞–∂–º–∏—Ç–µ **Finish**

VM —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ **–ù–ï –∑–∞–ø—É—Å–∫–∞–π—Ç–µ –µ—ë!**

---

## –≠—Ç–∞–ø 6: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GPU –≤ VM

### 6.1 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ PCI —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —á–µ—Ä–µ–∑ Web UI

–í—ã–±–µ—Ä–∏—Ç–µ VM 300 ‚Üí **Hardware**

#### 6.1.1 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GPU

1. –ù–∞–∂–º–∏—Ç–µ **Add** ‚Üí **PCI Device**
2. **Raw Device:** –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É NVIDIA GPU (01:00.0 –∏–ª–∏ 06:00.0)
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≥–∞–ª–æ—á–∫–∏:
   - ‚úÖ **All Functions** (–≤–∞–∂–Ω–æ - –∑–∞—Ö–≤–∞—Ç–∏—Ç GPU –∏ Audio –≤–º–µ—Å—Ç–µ, –µ—Å–ª–∏ –µ—Å—Ç—å Audio)
   - ‚úÖ **Primary GPU** (–µ—Å–ª–∏ —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è GPU –≤ —Å–∏—Å—Ç–µ–º–µ)
   - ‚úÖ **PCI-Express** (–¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
   - ‚úÖ **ROM-Bar** (–æ–±—ã—á–Ω–æ –Ω—É–∂–µ–Ω)
4. –ù–∞–∂–º–∏—Ç–µ **Add**

‚ö†Ô∏è **–í–∞–∂–Ω–æ –¥–ª—è –º–∞–π–Ω–∏–Ω–≥–æ–≤—ã—Ö –∫–∞—Ä—Ç (P106, P104, CMP):**
- –£ –Ω–∏—Ö –Ω–µ—Ç Audio –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞, –ø–æ—ç—Ç–æ–º—É "All Functions" –∑–∞—Ö–≤–∞—Ç–∏—Ç —Ç–æ–ª—å–∫–æ GPU
- **–ù–ï –≤–∫–ª—é—á–∞–π—Ç–µ x-vga=1** - —ç—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–ø—É—Å–∫–æ–º VM
- –î–ª—è –æ–±—ã—á–Ω—ã—Ö GTX/RTX –∫–∞—Ä—Ç x-vga=1 –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ —Å–ø–∏—Å–∫–µ Hardware:
```text
PCI Device (hostpci0): 0000:01:00, All Functions
```
–ò–ª–∏ –¥–ª—è P106:
```text
PCI Device (hostpci0): 0000:06:00, All Functions
```

### 6.2 –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VM (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
nano /etc/pve/qemu-server/300.conf
```

**‚ö†Ô∏è –í–∞–∂–Ω–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:**
1. Proxmox Web UI —É–∂–µ —Å–æ–∑–¥–∞–ª —Å—Ç—Ä–æ–∫—É `cpu: host`
2. –í—ã –¥–æ–±–∞–≤–∏—Ç–µ —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é `cpu: host,hidden=1,flags=+pcid`
3. **–£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—É—é —Å—Ç—Ä–æ–∫—É** `cpu: host` (–±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
4. –û—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

–ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É `cpu: host` (–±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤) –∏ **–∑–∞–º–µ–Ω–∏—Ç–µ –µ—ë** –Ω–∞:

```text
cpu: host,hidden=1,flags=+pcid
args: -cpu host,kvm=off
```

**–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–≤—É—Ö —Å—Ç—Ä–æ–∫ cpu!**

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `hidden=1` - —Å–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç VM —á—Ç–æ –æ–Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ NVIDIA –¥—Ä–∞–π–≤–µ—Ä—ã —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—é—Ç)
- `kvm=off` - —Å–∫—Ä—ã–≤–∞–µ—Ç KVM signature (–¥–ª—è NVIDIA driver detection)
- `+pcid` - Process-Context Identifiers (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ: Ctrl+O, Enter, Ctrl+X

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```bash
cat /etc/pve/qemu-server/300.conf | grep "^cpu:"
```

–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å **—Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞** —Å—Ç—Ä–æ–∫–∞ —Å cpu!

**–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:**

```text
bootdisk: scsi0
cores: 4
cpu: host,hidden=1,flags=+pcid
args: -cpu host,kvm=off
efidisk0: local-lvm:vm-300-disk-0,efitype=4m,size=4M
hostpci0: 0000:01:00,pcie=1,x-vga=1
memory: 8192
meta: creation-qemu=8.1.5,ctime=1728600000
name: ollama-vm
net0: virtio=XX:XX:XX:XX:XX:XX,bridge=vmbr0
numa: 0
ostype: l26
scsi0: local-lvm:vm-300-disk-1,iothread=1,size=50G
scsihw: virtio-scsi-single
smbios1: uuid=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
sockets: 1
vmgenid: XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
```

---

## –≠—Ç–∞–ø 7: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Ubuntu Server –≤ VM

### 7.1 –ó–∞–ø—É—Å–∫ VM

Proxmox Web UI ‚Üí VM 300 ‚Üí **Start**

–ó–∞—Ç–µ–º ‚Üí **Console** (–æ—Ç–∫—Ä–æ–µ—Ç—Å—è noVNC)

–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∫–∏ Ubuntu installer (~30 —Å–µ–∫—É–Ω–¥).

### 7.2 Ubuntu Installation Wizard

**Language:**
- English (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è troubleshooting)

**Keyboard configuration:**
- Layout: English (US) –∏–ª–∏ Russian
- Variant: English (US)

**Network connections:**
- –û—Å—Ç–∞–≤—å—Ç–µ DHCP (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç IP)
- –ó–∞–ø–æ–º–Ω–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–π IP –∞–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 192.168.1.150)

**Configure proxy:**
- –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º

**Configure Ubuntu archive mirror:**
- –û—Å—Ç–∞–≤—å—Ç–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**Guided storage configuration:**
- ‚úÖ Use an entire disk
- Disk: `/dev/sda` (50GB VirtIO disk)
- ‚ùå Set up this disk as an LVM group (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å, –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

**Storage configuration:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ç–∫—É
- Continue (–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ)

**Profile setup:**
- Your name: `Administrator`
- Your server's name: `ollama-vm`
- Pick a username: `admin` (–∏–ª–∏ –¥—Ä—É–≥–æ–µ)
- Choose a password: `<–Ω–∞–¥–µ–∂–Ω—ã–π_–ø–∞—Ä–æ–ª—å>`
- Confirm your password: `<–Ω–∞–¥–µ–∂–Ω—ã–π_–ø–∞—Ä–æ–ª—å>`

**Upgrade to Ubuntu Pro:**
- Skip for now

**SSH Setup:**
- ‚úÖ Install OpenSSH server (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
- ‚ùå Import SSH identity (–Ω–µ –Ω—É–∂–Ω–æ)

**Featured Server Snaps:**
- –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±–∏—Ä–∞–π—Ç–µ (—É—Å—Ç–∞–Ω–æ–≤–∏–º –ø–æ–∑–∂–µ —á—Ç–æ –Ω—É–∂–Ω–æ)

–ù–∞—á–Ω–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (~5-10 –º–∏–Ω—É—Ç).

### 7.3 –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

–ö–æ–≥–¥–∞ —É–≤–∏–¥–∏—Ç–µ **"Reboot Now"**:

1. –ù–∞–∂–º–∏—Ç–µ **Reboot Now**
2. VM –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
3. –î–æ–∂–¥–∏—Ç–µ—Å—å login prompt

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** –í–∏–¥–∏—Ç–µ `ollama-vm login:`

---

## –≠—Ç–∞–ø 8: –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Ubuntu VM

### 8.1 –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ SSH

–° –≤–∞—à–µ–π —Ä–∞–±–æ—á–µ–π –º–∞—à–∏–Ω—ã:

```bash
ssh admin@<VM_IP>
```

–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π –Ω–∞ —à–∞–≥–µ 7.2.

**–ï—Å–ª–∏ SSH –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ IP: –≤ Proxmox Web UI ‚Üí VM 300 ‚Üí Summary ‚Üí IPs
- –ò–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å –≤ VM: `ip addr show`

### 8.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

```bash
sudo apt update
sudo apt upgrade -y
```

–ï—Å–ª–∏ —Å–ø—Ä–æ—Å–∏—Ç –æ restart services - –≤—ã–±–µ—Ä–∏—Ç–µ **Yes** –∏ **OK** –¥–ª—è –≤—Å–µ—Ö.

### 8.3 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö —É—Ç–∏–ª–∏—Ç

```bash
sudo apt install -y curl wget git build-essential
```

### 8.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ GPU

```bash
lspci | grep -i nvidia
```

**–î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:**
```text
00:10.0 VGA compatible controller: NVIDIA Corporation GP107 [GeForce GTX 1050 Ti]
00:10.1 Audio device: NVIDIA Corporation GP107GL High Definition Audio Controller
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** GPU –≤–∏–¥–µ–Ω –≤ VM (PCI –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç –¥—Ä—É–≥–æ–π, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ).

**–ï—Å–ª–∏ GPU –Ω–µ –≤–∏–¥–µ–Ω:**
- –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ Proxmox Web UI ‚Üí VM 300 ‚Üí Hardware
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ PCI Device –¥–æ–±–∞–≤–ª–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ VM –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–∫–ª—é—á–µ–Ω–∞ (Shutdown) –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ Hardware
- Restart VM

---

## –≠—Ç–∞–ø 9: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NVIDIA –¥—Ä–∞–π–≤–µ—Ä–æ–≤ –≤ Ubuntu VM

### 9.1 –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –¥—Ä–∞–π–≤–µ—Ä–∞

```bash
sudo ubuntu-drivers devices
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```text
== /sys/devices/pci0000:00/0000:00:10.0 ==
modalias : pci:v000010DEd00001C82sv00001462sd00008C96bc03sc00i00
vendor   : NVIDIA Corporation
model    : GP107 [GeForce GTX 1050 Ti]
driver   : nvidia-driver-535 - distro non-free recommended
driver   : nvidia-driver-545 - third-party non-free
driver   : nvidia-driver-470 - distro non-free
```

**Recommended:** `nvidia-driver-535` (–∏–ª–∏ –Ω–æ–≤–µ–µ)

### 9.2 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NVIDIA –¥—Ä–∞–π–≤–µ—Ä–∞

**–í–∞—Ä–∏–∞–Ω—Ç A: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

```bash
sudo ubuntu-drivers autoinstall
```

–≠—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç recommended –≤–µ—Ä—Å–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

**–í–∞—Ä–∏–∞–Ω—Ç B: –†—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏**

```bash
sudo apt install -y nvidia-driver-535 nvidia-utils-535
```

–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–π–º–µ—Ç 3-5 –º–∏–Ω—É—Ç (—Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è ~500MB –ø–∞–∫–µ—Ç–æ–≤).

### 9.3 –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ VM

```bash
sudo reboot
```

–ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã.

### 9.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ NVIDIA –¥—Ä–∞–π–≤–µ—Ä–∞

```bash
ssh admin@<VM_IP>

nvidia-smi
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```text
Fri Oct 11 01:00:00 2025
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 535.183.01             Driver Version: 535.183.01   CUDA Version: 12.2     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id        Disp.A  | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage  | GPU-Util  Compute M. |
|                                         |                       |               MIG M. |
|=========================================+========================+======================|
|   0  NVIDIA GeForce GTX 1050 Ti     Off | 00000000:00:10.0  Off |                  N/A |
| 40%   35C    P0              N/A /  75W |      0MiB /  4096MiB  |      0%      Default |
|                                         |                       |                  N/A |
+-----------------------------------------+------------------------+----------------------+
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:**
- –í–∏–¥–Ω–∞ –º–æ–¥–µ–ª—å GPU: GeForce GTX 1050 Ti
- Driver Version: 535.xxx –∏–ª–∏ –Ω–æ–≤–µ–µ
- CUDA Version: 12.x
- Memory: 4096 MiB

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "NVIDIA-SMI has failed":**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
dpkg -l | grep nvidia-driver

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞
sudo apt install --reinstall nvidia-driver-535

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è
lsmod | grep nvidia

# –ï—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
sudo modprobe nvidia
nvidia-smi
```

---

## –≠—Ç–∞–ø 10: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Ollama

### 10.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Ollama

```bash
# –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π install script
curl -fsSL https://ollama.ai/install.sh | sh
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. –°–∫–∞—á–∏–≤–∞–µ—Ç –±–∏–Ω–∞—Ä–Ω–∏–∫ Ollama
2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤ `/usr/local/bin/ollama`
3. –°–æ–∑–¥–∞–µ—Ç systemd unit `/etc/systemd/system/ollama.service`
4. –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–∏—Å

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:**
```bash
ollama --version
# –í—ã–≤–æ–¥: ollama version is 0.x.x

systemctl status ollama.service
# –í—ã–≤–æ–¥: active (running)
```

### 10.2 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ API

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Ollama —Å–ª—É—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ 127.0.0.1. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ n8n –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 0.0.0.0.

**‚ö†Ô∏è –í–∞–∂–Ω–æ:** –ï—Å–ª–∏ `systemctl edit` –Ω–µ —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Å–æ–∑–¥–∞–¥–∏–º –≤—Ä—É—á–Ω—É—é.

#### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ systemctl edit (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):

```bash
sudo systemctl edit ollama.service
```

–û—Ç–∫—Ä–æ–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–æ—Ä. –î–æ–±–∞–≤—å—Ç–µ **—Ç–æ–ª—å–∫–æ —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏** (–º–µ–∂–¥—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏):

```ini
[Service]
Environment="OLLAMA_HOST=0.0.0.0:11434"
Environment="OLLAMA_ORIGINS=*"
Environment="CUDA_VISIBLE_DEVICES=0"
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ: Ctrl+O, Enter, Ctrl+X

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ï—Å–ª–∏ –í–∞—Ä–∏–∞–Ω—Ç A –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ñ–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è):

```bash
sudo mkdir -p /etc/systemd/system/ollama.service.d
sudo nano /etc/systemd/system/ollama.service.d/override.conf
```

–î–æ–±–∞–≤—å—Ç–µ:
```ini
[Service]
Environment="OLLAMA_HOST=0.0.0.0:11434"
Environment="OLLAMA_ORIGINS=*"
Environment="CUDA_VISIBLE_DEVICES=0"
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ: Ctrl+O, Enter, Ctrl+X

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω:**
```bash
sudo cat /etc/systemd/system/ollama.service.d/override.conf
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å 4 —Å—Ç—Ä–æ–∫–∏ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `OLLAMA_HOST=0.0.0.0:11434` - —Å–ª—É—à–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
- `OLLAMA_ORIGINS=*` - —Ä–∞–∑—Ä–µ—à–∏—Ç—å CORS –¥–ª—è –ª—é–±—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- `CUDA_VISIBLE_DEVICES=0` - —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPU 0

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```bash
sudo systemctl daemon-reload
sudo systemctl restart ollama.service
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å:**
```bash
sudo ss -tlnp | grep 11434
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:** `*:11434` –∏–ª–∏ `0.0.0.0:11434` (–ù–ï 127.0.0.1:11434)

### 10.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoint

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ –≤ VM
curl http://localhost:11434/api/tags

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:
# {"models":[]}
```

–° Proxmox —Ö–æ—Å—Ç–∞ –∏–ª–∏ –≤–∞—à–µ–π —Ä–∞–±–æ—á–µ–π –º–∞—à–∏–Ω—ã:

```bash
curl http://<VM_IP>:11434/api/tags

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Ç–æ—Ç –∂–µ JSON
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** API –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã –ø–æ —Å–µ—Ç–∏.

**–ï—Å–ª–∏ Connection refused:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–µ—Ä–≤–∏—Å —Å–ª—É—à–∞–µ—Ç –Ω–∞ 0.0.0.0
sudo ss -tlnp | grep 11434

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 0.0.0.0:11434 (–Ω–µ 127.0.0.1)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
systemctl show ollama.service | grep Environment

# –î–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å: OLLAMA_HOST=0.0.0.0:11434

# –ï—Å–ª–∏ –Ω–µ—Ç, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ —à–∞–≥ 10.2
```

---

## –≠—Ç–∞–ø 11: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏

### 11.1 –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –ø–æ VRAM

**–î–ª—è GTX 1050 Ti (4GB VRAM):**

| –ú–æ–¥–µ–ª—å | –†–∞–∑–º–µ—Ä | VRAM | –°–∫–æ—Ä–æ—Å—Ç—å –≤ VM | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|--------|--------|------|---------------|--------------|
| `phi3:mini` | 2.3GB | ~2.5GB | 40-50 tok/s | ‚úÖ –õ—É—á—à–∏–π –±–∞–ª–∞–Ω—Å |
| `llama3.2:3b` | 2GB | ~2.2GB | 50-60 tok/s | ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ |
| `qwen2.5:3b` | 2GB | ~2.2GB | 40-50 tok/s | ‚úÖ –•–æ—Ä–æ—à–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ |
| `gemma2:2b` | 1.6GB | ~1.8GB | 70+ tok/s | ‚úÖ –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** `phi3:mini` - –æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.

### 11.2 –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏

```bash
ollama pull phi3:mini
```

**–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏:**
```text
pulling manifest
pulling 8c83cdcf6a98... 100% ‚ñï‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè 2.3 GB
pulling ed11eda7790d... 100% ‚ñï‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè  106 B
pulling ca31f59a46fb... 100% ‚ñï‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè  485 B
verifying sha256 digest
writing manifest
removing any unused layers
success
```

–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: ~2-5 –º–∏–Ω—É—Ç (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞).

### 11.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏

```bash
ollama list
```

**–í—ã–≤–æ–¥:**
```text
NAME         ID          SIZE    MODIFIED
phi3:mini    1a4e8c5f... 2.3 GB  2 minutes ago
```

### 11.4 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ —Å GPU

```bash
ollama run phi3:mini "–ü—Ä–∏–≤–µ—Ç! –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∫—Ä–∞—Ç–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∫–∞–∫ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —É–º–Ω–æ–≥–æ –¥–æ–º–∞"
```

**–í–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** –æ—Ç–∫—Ä–æ–π—Ç–µ –≤—Ç–æ—Ä–æ–π SSH —Å–µ–∞–Ω—Å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
watch -n 1 nvidia-smi
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- GPU-Util –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è –¥–æ 80-100% –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- Memory-Usage –ø–æ–∫–∞–∂–µ—Ç ~2500 MiB
- Temperature –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è –¥–æ 50-65¬∞C

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:**
- –ú–æ–¥–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- GPU –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (nvidia-smi –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É)
- –û—Ç–≤–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∑–∞ 3-5 —Å–µ–∫—É–Ω–¥

**–ï—Å–ª–∏ GPU –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (0% utilization):**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ CUDA –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
nvidia-smi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º GPU
CUDA_VISIBLE_DEVICES=0 ollama run phi3:mini "test"

# –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–æ–±–∞–≤—å—Ç–µ –≤ systemd (—É–∂–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–∑ 10.2)
systemctl show ollama.service | grep CUDA_VISIBLE_DEVICES
```

### 11.5 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API

```bash
curl http://localhost:11434/api/generate -H "Content-Type: application/json" -d '{
  "model": "phi3:mini",
  "prompt": "–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ —Å–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞–∫ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞",
  "stream": false
}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "model": "phi3:mini",
  "created_at": "2025-10-11T01:00:00.000Z",
  "response": "–Ø AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–ø–æ—Å–æ–±–Ω—ã–π –ø–æ–º–æ–≥–∞—Ç—å —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏...",
  "done": true,
  "total_duration": 4500000000,
  "load_duration": 500000000,
  "prompt_eval_duration": 100000000,
  "eval_count": 85,
  "eval_duration": 2000000000
}
```

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- `eval_count` / (`eval_duration` / 1e9) = tokens per second
- –î–ª—è phi3:mini –æ–∂–∏–¥–∞–µ—Ç—Å—è: ~40-50 tokens/sec

---

## –≠—Ç–∞–ø 12: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n

### 12.1 –°–∫–∞—á–∏–≤–∞–Ω–∏–µ workflow

–ù–∞ –≤–∞—à–µ–π —Ä–∞–±–æ—á–µ–π –º–∞—à–∏–Ω–µ:

```bash
cd /home/gfer/HASSio
# –§–∞–π–ª —É–∂–µ –µ—Å—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
ls -lh docs/integrations/n8n-voice-assistant-ollama.json
```

### 12.2 –ò–º–ø–æ—Ä—Ç –≤ n8n

1. –û—Ç–∫—Ä–æ–π—Ç–µ n8n Web UI
2. **Workflows** ‚Üí **Add workflow** ‚Üí **Import from File**
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª `n8n-voice-assistant-ollama.json`
4. Workflow –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å 16 nodes

### 12.3 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Ollama node

–ù–∞–π–¥–∏—Ç–µ node **"Ollama: Model"**:

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- **Base URL:** `http://<VM_IP>:11434` (IP –≤–∞—à–µ–π Ollama VM)
- **Model:** `phi3:mini`

–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

```bash
# –° –º–∞—à–∏–Ω—ã –≥–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç n8n
curl http://<VM_IP>:11434/api/tags
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π.

### 12.4 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Home Assistant

Node **"HA: Get All States"**:

- **URL:** `http://<HA_IP>:8123/api/states`
- **Authentication:** Header Auth
- **Credential:** –°–æ–∑–¥–∞–π—Ç–µ –≤ n8n:
  - Type: HTTP Header Auth
  - Name: `Authorization`
  - Value: `Bearer <YOUR_HA_LONG_LIVED_TOKEN>`

**–ü–æ–ª—É—á–µ–Ω–∏–µ HA —Ç–æ–∫–µ–Ω–∞:**
1. Home Assistant ‚Üí –ü—Ä–æ—Ñ–∏–ª—å (–ª–µ–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª)
2. Long-Lived Access Tokens ‚Üí Create Token
3. Name: `n8n-ollama`
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω

### 12.5 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Telegram

–°–æ–∑–¥–∞–π—Ç–µ Telegram Bot:
1. Telegram ‚Üí @BotFather ‚Üí `/newbot`
2. Name: `My Home Assistant Bot`
3. Username: `my_ha_ollama_bot`
4. –ü–æ–ª—É—á–∏—Ç–µ token: `123456:ABCdefGHI...`

–ü–æ–ª—É—á–∏—Ç–µ –≤–∞—à Telegram ID:
1. Telegram ‚Üí @userinfobot ‚Üí –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID

–í n8n —Å–æ–∑–¥–∞–π—Ç–µ Telegram credential:
- Type: Telegram API
- Access Token: `123456:ABCdefGHI...`

Node **"Telegram: Trigger"**:
- **User IDs:** –≤–∞—à Telegram ID
- **Credential:** –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Telegram credential

### 12.6 –°–æ–∑–¥–∞–Ω–∏–µ Tool workflows

–î–ª—è —Ä–∞–±–æ—Ç—ã AI Agent –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å 5 sub-workflows –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Home Assistant.

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä - Tool "Turn On Light":**

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π workflow: **+ Add workflow**
2. –î–æ–±–∞–≤—å—Ç–µ node **HTTP Request**:
   - Method: `POST`
   - URL: `http://<HA_IP>:8123/api/services/light/turn_on`
   - Authentication: Header Auth (–≤–∞—à HA credential)
   - Body Content Type: JSON
   - Body:
   ```json
   {
     "entity_id": "={{ $json.entity_id }}"
   }
   ```
3. **Save** workflow
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID workflow (–∏–∑ URL: `.../workflow/<ID>`)
5. –í –≥–ª–∞–≤–Ω–æ–º workflow –Ω–∞–π–¥–∏—Ç–µ node **"Tool: Turn On Light"**
6. –ü–∞—Ä–∞–º–µ—Ç—Ä **Workflow ID:** –≤—Å—Ç–∞–≤—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID

–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö tools:
- `Tool: Turn Off Light` - POST `/api/services/light/turn_off`
- `Tool: Set Temperature` - POST `/api/services/climate/set_temperature`
- `Tool: Activate Scene` - POST `/api/services/scene/turn_on`
- `Tool: Get Sensor` - GET `/api/states/{{ $json.entity_id }}`

### 12.7 –ê–∫—Ç–∏–≤–∞—Ü–∏—è workflow

1. **Save** –≥–ª–∞–≤–Ω—ã–π workflow
2. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ toggle —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É (Active)
3. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram ‚Üí –Ω–∞–π–¥–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ: `/start`

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```text
ü§ñ –¢–µ–∫—Å—Ç–æ–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Home Assistant + Ollama

*–ö–æ–º–∞–Ω–¥—ã:*
‚Ä¢ –í–∫–ª—é—á–∏/–≤—ã–∫–ª—é—á–∏ —Å–≤–µ—Ç [–∫–æ–º–Ω–∞—Ç–∞]
...
```

---

## –≠—Ç–∞–ø 13: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### 13.1 –ü—Ä–æ—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞

–í Telegram –±–æ—Ç—É:
```text
–ü—Ä–∏–≤–µ—Ç!
```

–ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å —á–µ—Ä–µ–∑ 3-5 —Å–µ–∫—É–Ω–¥.

### 13.2 –ö–æ–º–∞–Ω–¥–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```text
–í–∫–ª—é—á–∏ —Å–≤–µ—Ç –Ω–∞ –∫—É—Ö–Ω–µ
```

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å `light.kitchen`, –±–æ—Ç –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É.

### 13.3 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ GPU

–í–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞:

```bash
# –í VM
watch -n 1 nvidia-smi
```

–ù–∞–±–ª—é–¥–∞–π—Ç–µ:
- GPU-Util: 80-100% –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- Memory: ~2.5GB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- Temperature: 45-65¬∞C

### 13.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ò–∑–º–µ—Ä—å—Ç–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:
- –ü—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å: 2-4 —Å–µ–∫—É–Ω–¥—ã
- –ö–æ–º–∞–Ω–¥–∞ —Å –≤—ã–∑–æ–≤–æ–º tool: 4-7 —Å–µ–∫—É–Ω–¥
- –°–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å: 5-8 —Å–µ–∫—É–Ω–¥

**–î–ª—è GTX 1050 Ti + phi3:mini —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.**

---

## –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Snapshot VM –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

```bash
# –ù–∞ Proxmox —Ö–æ—Å—Ç–µ
qm snapshot 300 clean-phi3mini-install
```

### Backup VM

```bash
# Snapshot backup
vzdump 300 --mode snapshot --storage local --compress zstd

# Backup —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ /var/lib/vz/dump/
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Ollama

```bash
ssh admin@<VM_IP>

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
curl -fsSL https://ollama.ai/install.sh | sh

# –†–µ—Å—Ç–∞—Ä—Ç
sudo systemctl restart ollama.service
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –ø–æ—Å–ª–µ –∞–ø–≥—Ä–µ–π–¥–∞ GPU

–ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã GTX 1050 Ti –Ω–∞ GTX 1060 (6GB):

```bash
# –ó–∞–≥—Ä—É–∑–∫–∞ –±–æ–ª–µ–µ –º–æ—â–Ω–æ–π –º–æ–¥–µ–ª–∏
ollama pull llama3.1:8b

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
ollama list

# –¢–µ—Å—Ç
ollama run llama3.1:8b "–¢–µ—Å—Ç –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏"

# –í n8n –æ–±–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä model –Ω–∞ "llama3.1:8b"
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: VM –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è - Cannot allocate memory

**–°–∏–º–ø—Ç–æ–º—ã:** `QEMU exited with code 1`, –≤ –ª–æ–≥–∞—Ö: `Cannot allocate memory (12)`

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# –ù–∞ Proxmox —Ö–æ—Å—Ç–µ
free -h
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Total –∏ Available RAM

cat /etc/pve/qemu-server/<VMID>.conf | grep memory
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∫–æ–ª—å–∫–æ RAM –≤—ã–¥–µ–ª–µ–Ω–æ VM
```

**–ü—Ä–∏—á–∏–Ω–∞:** VM –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–¥–µ–ª–∏—Ç—å –±–æ–ª—å—à–µ RAM —á–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Ö–æ—Å—Ç–µ.

**–†–µ—à–µ–Ω–∏–µ:**

1. **–£–º–µ–Ω—å—à–∏—Ç–µ RAM VM:**
   ```bash
   # –ù–∞ —Ö–æ—Å—Ç–µ (VM –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–∫–ª—é—á–µ–Ω–∞)
   qm set <VMID> --memory 6144  # 6GB –≤–º–µ—Å—Ç–æ 8GB
   ```

2. **–ò–ª–∏ —á–µ—Ä–µ–∑ Web UI:**
   - VM ‚Üí Hardware ‚Üí Memory ‚Üí Edit
   - –£–º–µ–Ω—å—à–∏—Ç–µ –¥–æ 4096-6144 MB

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ VM:**
   ```bash
   qm start <VMID>
   ```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- **8GB —Ö–æ—Å—Ç:** VM –º–∞–∫—Å–∏–º—É–º 6GB
- **16GB —Ö–æ—Å—Ç:** VM –º–∞–∫—Å–∏–º—É–º 12GB
- **32GB —Ö–æ—Å—Ç:** VM –º–∞–∫—Å–∏–º—É–º 24GB

**–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á—å—Ç–µ RAM –Ω–∞ Proxmox —Ö–æ—Å—Ç–µ –¥–æ 16GB+.

---

### –ü—Ä–æ–±–ª–µ–º–∞: AMD-Vi –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è (IOMMU groups = 0)

**–°–∏–º–ø—Ç–æ–º—ã:** –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GRUB `ls /sys/kernel/iommu_groups/` –ø—É—Å—Ç–æ–π, AMD-Vi –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ dmesg

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ IVRS —Ç–∞–±–ª–∏—Ü—ã
dmesg | grep -i ivrs
# –ï—Å–ª–∏ –ø—É—Å—Ç–æ - BIOS –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç IOMMU –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —è–¥—Ä–∞
cat /proc/cmdline
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: iommu=pt

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ BIOS
dmidecode -s bios-version
```

**–†–µ—à–µ–Ω–∏–µ:**

1. **–í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ BIOS:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ **IOMMU = Enabled** (AMD CBS —Ä–∞–∑–¥–µ–ª)
   - –î–ª—è ASRock: –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ BIOS –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏

2. **–ï—Å–ª–∏ IVRS –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–æ AMD-Vi –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è:**
   ```bash
   # –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å amd_iommu=on
   nano /etc/default/grub
   GRUB_CMDLINE_LINUX_DEFAULT="quiet amd_iommu=on iommu=pt"
   update-grub
   reboot
   ```
   (–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "Unknown option" –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ AMD-Vi –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è)

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
   ```bash
   dmesg | grep -i amd-vi
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: AMD-Vi: Interrupt remapping enabled

   ls /sys/kernel/iommu_groups/ | wc -l
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: VM –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è GPU

**–°–∏–º–ø—Ç–æ–º—ã:** Black screen, VM –∑–∞–≤–∏—Å–∞–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**

1. –í—ã–∫–ª—é—á–∏—Ç–µ VM –ø–æ–ª–Ω–æ—Å—Ç—å—é (Shutdown, –Ω–µ Reset)
2. Proxmox Web UI ‚Üí VM 300 ‚Üí Hardware
3. –£–¥–∞–ª–∏—Ç–µ PCI Device (hostpci0)
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ VM - –¥–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–µ:
   ```bash
   lspci -nnk | grep -A 3 nvidia
   # –£–±–µ–¥–∏—Ç–µ—Å—å: Kernel driver in use: vfio-pci
   ```
6. –í—ã–∫–ª—é—á–∏—Ç–µ VM
7. –î–æ–±–∞–≤—å—Ç–µ PCI Device —Å–Ω–æ–≤–∞:
   - ‚úÖ All Functions
   - ‚úÖ Primary GPU
   - ‚úÖ PCI-Express
8. –ó–∞–ø—É—Å—Ç–∏—Ç–µ VM

### –ü—Ä–æ–±–ª–µ–º–∞: GPU –≤–∏–¥–µ–Ω, –Ω–æ nvidia-smi –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–°–∏–º–ø—Ç–æ–º—ã:** `NVIDIA-SMI has failed because it couldn't communicate with the NVIDIA driver`

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –¥—Ä–∞–π–≤–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
dpkg -l | grep nvidia-driver-535

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞
lsmod | grep nvidia

# 3. –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è –≤—Ä—É—á–Ω—É—é
sudo modprobe nvidia

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞
nvidia-smi

# 5. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ - –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞
sudo apt purge nvidia-*
sudo apt autoremove
sudo ubuntu-drivers autoinstall
sudo reboot
```

### –ü—Ä–æ–±–ª–µ–º–∞: Ollama –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç (CPU mode)

**–°–∏–º–ø—Ç–æ–º—ã:** –û—Ç–≤–µ—Ç—ã –∑–∞ 20-30+ —Å–µ–∫—É–Ω–¥, nvidia-smi –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0% GPU util

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ CUDA
nvidia-smi

# 2. –¢–µ—Å—Ç Ollama —Å —è–≤–Ω—ã–º GPU
CUDA_VISIBLE_DEVICES=0 ollama run phi3:mini "test"

# –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø—Ä–æ–±–ª–µ–º–∞ –≤ systemd unit:
sudo systemctl edit ollama.service

# –î–æ–±–∞–≤—å—Ç–µ:
# [Service]
# Environment="CUDA_VISIBLE_DEVICES=0"

sudo systemctl daemon-reload
sudo systemctl restart ollama.service
```

### –ü—Ä–æ–±–ª–µ–º–∞: Out of Memory –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏

**–°–∏–º–ø—Ç–æ–º—ã:** Ollama –∫—Ä–∞—à–∏—Ç—Å—è –ø—Ä–∏ `ollama run`, –æ—à–∏–±–∫–∞ CUDA OOM

**–†–µ—à–µ–Ω–∏–µ:**

1. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω—å—à—É—é –º–æ–¥–µ–ª—å:
   ```bash
   # –í–º–µ—Å—Ç–æ phi3:mini –ø–æ–ø—Ä–æ–±—É–π—Ç–µ
   ollama pull gemma2:2b
   ```

2. –£–≤–µ–ª–∏—á—å—Ç–µ RAM VM (–Ω–∞ Proxmox —Ö–æ—Å—Ç–µ):
   ```bash
   # –í—ã–∫–ª—é—á–∏—Ç–µ VM
   qm shutdown 300

   # –£–≤–µ–ª–∏—á—å—Ç–µ –¥–æ 12GB
   qm set 300 --memory 12288

   # –ó–∞–ø—É—Å—Ç–∏—Ç–µ
   qm start 300
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: Ollama –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å–µ—Ç–∏ (—Å–ª—É—à–∞–µ—Ç –Ω–∞ 127.0.0.1)

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í VM: `curl http://localhost:11434/api/tags` —Ä–∞–±–æ—Ç–∞–µ—Ç
- –° —Ö–æ—Å—Ç–∞: `curl http://<VM_IP>:11434/api/tags` ‚Üí Connection refused
- `sudo ss -tlnp | grep 11434` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `127.0.0.1:11434` –≤–º–µ—Å—Ç–æ `0.0.0.0:11434`

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `OLLAMA_HOST` –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∞—Å—å.

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ override.conf —Å–æ–∑–¥–∞–Ω:**
   ```bash
   sudo cat /etc/systemd/system/ollama.service.d/override.conf
   ```

   –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç - —Å–æ–∑–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é (—Å–º. –≠—Ç–∞–ø 10.2, –í–∞—Ä–∏–∞–Ω—Ç B)

2. **–ï—Å–ª–∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è:**
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl restart ollama.service
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```bash
   systemctl show ollama.service | grep OLLAMA_HOST
   ```

   –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `Environment=OLLAMA_HOST=0.0.0.0:11434`

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ç–µ–ø–µ—Ä—å —Å–ª—É—à–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö:**
   ```bash
   sudo ss -tlnp | grep 11434
   ```

   –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `*:11434` –∏–ª–∏ `0.0.0.0:11434`

5. **–ï—Å–ª–∏ –≤—Å—ë –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –≤—Ä–µ–º–µ–Ω–Ω—ã–π workaround:**
   ```bash
   sudo systemctl stop ollama.service
   OLLAMA_HOST=0.0.0.0:11434 ollama serve
   ```

   –ï—Å–ª–∏ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–æ - –ø—Ä–æ–±–ª–µ–º–∞ –≤ systemd override, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å —Ö–æ—Å—Ç–∞:**
```bash
# –ù–∞ Proxmox —Ö–æ—Å—Ç–µ
curl http://<VM_IP>:11434/api/tags
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Code 43 –≤ Device Manager (–µ—Å–ª–∏ Windows VM)

–ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ –∫ Ubuntu, –Ω–æ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏:
- –î–æ–±–∞–≤—å—Ç–µ `args: -cpu host,kvm=off` –≤ –∫–æ–Ω—Ñ–∏–≥ VM
- –≠—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—é –æ—Ç NVIDIA –¥—Ä–∞–π–≤–µ—Ä–∞

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –º–µ—Ç—Ä–∏–∫–∏

### GTX 1050 Ti (4GB) + phi3:mini –≤ VM

**Measured metrics:**
- Cold start latency: 4-6 —Å–µ–∫—É–Ω–¥
- Warm latency: 2-3 —Å–µ–∫—É–Ω–¥—ã
- Throughput: 40-50 tokens/sec
- VRAM usage: 2.4-2.6GB / 4GB
- GPU utilization: 85-95% –≤–æ –≤—Ä–µ–º—è inference
- Power draw: 50-70W (–∏–∑ 75W TDP)

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å LXC:** ~5-10% –º–µ–¥–ª–µ–Ω–Ω–µ–µ (–ø—Ä–∏–µ–º–ª–µ–º–æ –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

### GTX 1060 (6GB) + llama3.1:8b –ø–æ—Å–ª–µ –∞–ø–≥—Ä–µ–π–¥–∞

**Expected metrics:**
- Cold start latency: 5-8 —Å–µ–∫—É–Ω–¥
- Warm latency: 2-4 —Å–µ–∫—É–Ω–¥—ã
- Throughput: 30-45 tokens/sec
- VRAM usage: 4.8-5.2GB / 6GB
- GPU utilization: 80-90%

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### CPU pinning –¥–ª—è VM

–ù–∞ Proxmox —Ö–æ—Å—Ç–µ (–µ—Å–ª–∏ —É –≤–∞—Å 8+ cores):

```bash
# Pin VM –∫ specific cores (–Ω–∞–ø—Ä–∏–º–µ—Ä 4-7 –Ω–∞ 8-core CPU)
qm set 300 --cpulimit 4
nano /etc/pve/qemu-server/300.conf
```

–î–æ–±–∞–≤—å—Ç–µ:
```text
affinity: 4-7
```

### Huge pages (–¥–ª—è –º–æ–¥–µ–ª–µ–π 8B+)

–ù–∞ Proxmox —Ö–æ—Å—Ç–µ:

```bash
# –í—ã–¥–µ–ª–∏—Ç—å 4GB huge pages (–¥–ª—è llama3.1:8b)
sysctl vm.nr_hugepages=2048

# Persistent:
echo "vm.nr_hugepages=2048" >> /etc/sysctl.conf
```

–í VM –∫–æ–Ω—Ñ–∏–≥–µ:
```text
hugepages: 1024
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –¥–≤—É–º—è GPU

–ï—Å–ª–∏ —É –≤–∞—Å **–¥–≤–µ –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, NVIDIA –¥–ª—è Ollama + AMD Radeon –¥–ª—è —Ö–æ—Å—Ç–∞), –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

### –í–∞—Ä–∏–∞–Ω—Ç 1: Radeon –¥–ª—è —Ö–æ—Å—Ç–∞, NVIDIA –¥–ª—è VM (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- **NVIDIA GPU** ‚Üí passthrough –≤ VM –¥–ª—è Ollama
- **AMD Radeon** ‚Üí –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ –¥–ª—è Proxmox –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –•–æ—Å—Ç –∏–º–µ–µ—Ç –≤–∏–¥–µ–æ-–≤—ã–≤–æ–¥ (—É–¥–æ–±–Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è)
- ‚úÖ NVIDIA –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–ª—è Ollama VM
- ‚úÖ –ú–∏–Ω–∏–º—É–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥—Ä–∞–π–≤–µ—Ä–æ–≤
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- ‚úÖ **–û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã CPU —Ö–æ—Å—Ç–∞** (–µ—Å–ª–∏ —Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CPU/iGPU –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∏)

**–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ —Ö–æ—Å—Ç–∞:**

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è (–±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π GPU –Ω–∞ —Ö–æ—Å—Ç–µ):**
- Proxmox —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ **headless —Ä–µ–∂–∏–º–µ** (–±–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∞) - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
- –ò–õ–ò –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **iGPU/CPU** –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∏ - –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU 2-5%
- –ò–õ–ò –≤–æ–æ–±—â–µ **–Ω–µ—Ç –≤–∏–¥–µ–æ-–≤—ã–≤–æ–¥–∞** - –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∏ —Å–±–æ—è—Ö —Å–µ—Ç–∏

**–° Radeon 7100 –Ω–∞ —Ö–æ—Å—Ç–µ:**
- ‚úÖ –í–∏–¥–µ–æ-–≤—ã–≤–æ–¥ —á–µ—Ä–µ–∑ GPU (–Ω–µ —á–µ—Ä–µ–∑ CPU)
- ‚úÖ **–û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç 2-5% CPU** (–µ—Å–ª–∏ –±—ã–ª iGPU –∞–∫—Ç–∏–≤–µ–Ω)
- ‚úÖ **–î–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Å–æ–ª–∏** –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
- ‚úÖ Radeon 7100 –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç **~10-15W** (—Å—Ç–∞—Ä–∞—è –∫–∞—Ä—Ç–∞, –Ω–∏–∑–∫–æ–µ —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ)
- ‚úÖ –î—Ä–∞–π–≤–µ—Ä—ã AMD –∑–∞–Ω–∏–º–∞—é—Ç **~50-100MB RAM** (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)

**–†–µ–∞–ª—å–Ω–∞—è –≤—ã–≥–æ–¥–∞:**
- CPU: **-2-5%** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è iGPU)
- RAM: **+50-100MB** (–¥—Ä–∞–π–≤–µ—Ä—ã AMD)
- –≠–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ: **+10-15W** (Radeon 7100)
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è (–µ—Å—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Å–æ–ª–∏!)

**–í—ã–≤–æ–¥:** –û—Å–Ω–æ–≤–Ω–∞—è –≤—ã–≥–æ–¥–∞ - **–Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ —É–¥–æ–±—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è**, –∞ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤. CPU –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è iGPU.

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**

```bash
# 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –æ–±–µ–∏—Ö GPU
lspci -nn | grep -E "VGA|3D"

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# 01:00.0 VGA [0300]: NVIDIA Corporation GP106 [P106-100] [10de:1c07]
# 06:00.0 VGA [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Radeon 7100 [1002:515e]

# 2. Blacklist —Ç–æ–ª—å–∫–æ NVIDIA (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º AMD –¥—Ä–∞–π–≤–µ—Ä—ã)
cat > /etc/modprobe.d/blacklist-nvidia.conf << 'EOF'
blacklist nouveau
blacklist nvidia
blacklist nvidiafb
EOF

# 3. VFIO —Ç–æ–ª—å–∫–æ –¥–ª—è NVIDIA (–ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ–π ID –∏–∑ —à–∞–≥–∞ 1)
echo "options vfio-pci ids=10de:1c07" > /etc/modprobe.d/vfio.conf

# 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å AMD –¥—Ä–∞–π–≤–µ—Ä—ã –Ω–∞ —Ö–æ—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –≤—ã–≤–æ–¥)
apt update
apt install -y firmware-amd-graphics

# 5. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
update-initramfs -u -k all
reboot
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:**

```bash
# NVIDIA –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ vfio-pci
lspci -nnk | grep -A 3 -i nvidia
# –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
# Kernel driver in use: vfio-pci

# AMD –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Ö–æ—Å—Ç–µ
lspci -nnk | grep -A 3 -i radeon
# –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
# Kernel driver in use: radeon (–∏–ª–∏ amdgpu –¥–ª—è –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç)
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –î–≤–µ VM - –∫–∞–∂–¥–∞—è —Å–æ —Å–≤–æ–µ–π GPU

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- **NVIDIA GPU** ‚Üí VM 1 (Ollama)
- **AMD Radeon** ‚Üí VM 2 (–¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–∏–¥–µ–æ-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**

```bash
# 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –æ–±–µ–∏—Ö GPU
lspci -nn | grep -E "VGA|3D"

# 2. Blacklist –æ–±–∞ GPU –Ω–∞ —Ö–æ—Å—Ç–µ
cat > /etc/modprobe.d/blacklist-gpu.conf << 'EOF'
blacklist nouveau
blacklist nvidia
blacklist nvidiafb
blacklist radeon
blacklist amdgpu
EOF

# 3. VFIO –¥–ª—è –æ–±–µ–∏—Ö GPU (–ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ–∏ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
echo "options vfio-pci ids=10de:1c07,1002:515e" > /etc/modprobe.d/vfio.conf

# 4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
update-initramfs -u -k all
reboot
```

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ GPU –≤ VM:**

- **VM 1 (Ollama):** –î–æ–±–∞–≤–∏—Ç—å NVIDIA —á–µ—Ä–µ–∑ Proxmox UI (Hardware ‚Üí Add ‚Üí PCI Device)
- **VM 2:** –î–æ–±–∞–≤–∏—Ç—å AMD —á–µ—Ä–µ–∑ Proxmox UI (Hardware ‚Üí Add ‚Üí PCI Device)

**–í–∞–∂–Ω–æ:** –ö–∞–∂–¥–∞—è GPU –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–π VM –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –î–≤–µ NVIDIA GPU –≤ –æ–¥–Ω–æ–π VM (–¥–ª—è –±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –î–≤–µ NVIDIA GPU –≤ –æ–¥–Ω–æ–π VM –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π (llama3.1:70b, mistral:large).

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏** GPU (–æ–±–µ NVIDIA)
- ‚ö†Ô∏è Ollama –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç multi-GPU —Ç–æ–ª—å–∫–æ –¥–ª—è CUDA (NVIDIA)
- ‚ö†Ô∏è AMD ROCm –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Ollama (–Ω–∞ 2025 –≥–æ–¥)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**

```bash
# 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –æ–±–µ–∏—Ö NVIDIA GPU
lspci -nn | grep -i nvidia

# 2. Blacklist NVIDIA –Ω–∞ —Ö–æ—Å—Ç–µ
cat > /etc/modprobe.d/blacklist-nvidia.conf << 'EOF'
blacklist nouveau
blacklist nvidia
blacklist nvidiafb
EOF

# 3. VFIO –¥–ª—è –æ–±–µ–∏—Ö NVIDIA (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
echo "options vfio-pci ids=10de:1c07,10de:1c82" > /etc/modprobe.d/vfio.conf

# 4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
update-initramfs -u -k all
reboot
```

**–í VM:**

```bash
# 1. –î–æ–±–∞–≤–∏—Ç—å –æ–±–µ GPU —á–µ—Ä–µ–∑ Proxmox UI –≤ –æ–¥–Ω—É VM

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å NVIDIA –¥—Ä–∞–π–≤–µ—Ä—ã (–∫–∞–∫ –æ–±—ã—á–Ω–æ)

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–±–µ GPU –≤–∏–¥–Ω—ã
nvidia-smi
# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –æ–±–µ GPU

# 4. Ollama –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±–µ GPU –µ—Å–ª–∏:
# - –ú–æ–¥–µ–ª—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–∞—è (7B+)
# - –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ VRAM –Ω–∞ –æ–±–µ–∏—Ö GPU
# - CUDA –≤–∏–¥–∏—Ç –æ–±–µ GPU

# –ú–æ–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å:
export CUDA_VISIBLE_DEVICES=0,1
ollama run llama3.1:8b
```

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –î–≤–µ GPU **–Ω–µ –¥–∞—é—Ç 2x —É—Å–∫–æ—Ä–µ–Ω–∏–µ** (–æ–±—ã—á–Ω–æ 1.5-1.7x)
- –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –∏ —Ä–∞–∑–º–µ—Ä–∞ batch
- –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –º–æ–¥–µ–ª–µ–π > 8B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –°–º–µ—à–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (NVIDIA + AMD)

**‚ö†Ô∏è –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
- NVIDIA –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CUDA, AMD –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ROCm
- Ollama –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ROCm (—Ç–æ–ª—å–∫–æ CUDA)
- –ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–µ GPU –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –æ–¥–Ω–æ–π VM –¥–ª—è Ollama

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ:**
- NVIDIA ‚Üí VM –¥–ª—è Ollama
- AMD ‚Üí –•–æ—Å—Ç –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è VM –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á

---

## –§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Proxmox VE Host (Debian 12 Bookworm)       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ IOMMU/VT-d: Enabled                    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ VFIO modules: Loaded                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ GPU bound to: vfio-pci                 ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ              ‚Üì PCI Passthrough              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Ubuntu Server 22.04 VM (ID: 300)       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚îÇ NVIDIA Driver 535+                 ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚îÇ CUDA 12.2                          ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚îÇ Ollama Service                     ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚îÇ API: 0.0.0.0:11434                 ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚îÇ Model: phi3:mini (2.3GB)           ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Resources:                             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - CPU: 4 cores (type: host)            ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - RAM: 8GB                             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - Disk: 50GB VirtIO                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - GPU: GTX 1050 Ti (passthrough)       ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Network: vmbr0
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  n8n Server                ‚îÇ
‚îÇ  HTTP: <VM_IP>:11434       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Langchain Agent      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ - Ollama LLM         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ - Memory Buffer      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ - HA Tools (5)       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Home Assistant            ‚îÇ
‚îÇ  REST API: :8123           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Telegram Bot              ‚îÇ
‚îÇ  User Interface            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ß–µ–∫–ª–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏

–ü—Ä–æ–π–¥–∏—Ç–µ—Å—å –ø–æ —Å–ø–∏—Å–∫—É, –≤—Å–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚úÖ:

**Proxmox —Ö–æ—Å—Ç:**
- ‚úÖ IOMMU enabled –≤ BIOS (–¥–ª—è ASRock: Advanced ‚Üí AMD CBS ‚Üí IOMMU)
- ‚úÖ BIOS –ø–µ—Ä–µ–¥–∞–µ—Ç IVRS —Ç–∞–±–ª–∏—Ü—É (`dmesg | grep -i ivrs` –Ω–µ –ø—É—Å—Ç–æ)
- ‚úÖ GRUB –æ–±–Ω–æ–≤–ª–µ–Ω —Å `iommu=pt` (–¥–ª—è AMD: `amd_iommu=on` –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- ‚úÖ IOMMU –≥—Ä—É–ø–ø—ã —Å–æ–∑–¥–∞–Ω—ã (`ls /sys/kernel/iommu_groups/ | wc -l` > 0)
- ‚úÖ AMD-Vi –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (`dmesg | grep -i amd-vi` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Interrupt remapping enabled")
- ‚úÖ VFIO –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (`lsmod | grep vfio`)
- ‚úÖ GPU captured by vfio-pci (`lspci -nnk` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Kernel driver in use: vfio-pci")
- ‚úÖ –ù–µ—Ç NVIDIA –¥—Ä–∞–π–≤–µ—Ä–æ–≤ –Ω–∞ —Ö–æ—Å—Ç–µ (`dpkg -l | grep nvidia` - –ø—É—Å—Ç–æ)

**Ubuntu VM:**
- ‚úÖ GPU –≤–∏–¥–µ–Ω –≤ VM (`lspci | grep nvidia`)
- ‚úÖ NVIDIA –¥—Ä–∞–π–≤–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (`nvidia-smi` —Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚úÖ Ollama —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω (`systemctl status ollama`)
- ‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω (`curl http://localhost:11434/api/tags`)
- ‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (`ollama list`)
- ‚úÖ GPU –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (`nvidia-smi` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ inference)

**n8n –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- ‚úÖ Workflow –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ Ollama node –Ω–∞—Å—Ç—Ä–æ–µ–Ω (Base URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)
- ‚úÖ HA credential —Å–æ–∑–¥–∞–Ω
- ‚úÖ Telegram credential —Å–æ–∑–¥–∞–Ω
- ‚úÖ 5 Tool workflows —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ Workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
- ‚úÖ Telegram –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç

---

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ù–∞ Proxmox —Ö–æ—Å—Ç–µ

```bash
# IOMMU —Å—Ç–∞—Ç—É—Å
dmesg | grep -i iommu

# VFIO –º–æ–¥—É–ª–∏
lsmod | grep vfio

# GPU binding
lspci -nnk | grep -A 3 nvidia

# IOMMU –≥—Ä—É–ø–ø—ã
for d in /sys/kernel/iommu_groups/*/devices/*; do
    n=${d#*/iommu_groups/*}; n=${n%%/*}
    printf 'Group %s: ' "$n"
    lspci -nns "${d##*/}"
done | sort -n -k2

# –°—Ç–∞—Ç—É—Å VM
qm status 300
qm config 300
```

### –í Ubuntu VM

```bash
# GPU –Ω–∞–ª–∏—á–∏–µ
lspci | grep -i nvidia

# NVIDIA –¥—Ä–∞–π–≤–µ—Ä
nvidia-smi
nvidia-smi -L

# CUDA –≤–µ—Ä—Å–∏—è
nvcc --version  # –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω CUDA toolkit (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

# Ollama —Å–µ—Ä–≤–∏—Å
systemctl status ollama.service
journalctl -u ollama.service -n 50

# Ollama –ø—Ä–æ—Ü–µ—Å—Å
ps aux | grep ollama

# –°–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø
ss -tlnp | grep 11434

# –ú–æ–¥–µ–ª–∏
ollama list

# –¢–µ—Å—Ç API
curl http://localhost:11434/api/tags
```

---

## –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

–î–∞–Ω–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞:

- **Proxmox Official Documentation**
  [PCI Passthrough Wiki](https://pve.proxmox.com/wiki/PCI_Passthrough)

- **Habr Community (—Ä—É—Å—Å–∫–∏–π)**
  [–ü—Ä–æ–±—Ä–æ—Å –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã –≤ Proxmox](https://habr.com/ru/articles/794568/)

- **Proxmox Forum**
  [Ollama + NVIDIA GPU Passthrough Discussion](https://forum.proxmox.com/threads/ubuntu-22-04-ollama-nvidia-3060-gpu-passthrough-and-drivers-all-looking-good-but.144104/)

- **Ollama Official**
  [GPU Support Documentation](https://github.com/ollama/ollama/blob/main/docs/gpu.md)

- **VFIO Documentation**
  [Linux VFIO Documentation](https://www.kernel.org/doc/html/latest/driver-api/vfio.html)

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ BIOS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (IOMMU enabled)
2. ‚úÖ Proxmox –Ω–∞—Å—Ç—Ä–æ–µ–Ω (GRUB, VFIO)
3. ‚úÖ GPU –ø—Ä–∏–≤—è–∑–∞–Ω –∫ vfio-pci
4. ‚úÖ Ubuntu VM —Å–æ–∑–¥–∞–Ω–∞
5. ‚úÖ GPU –ø–µ—Ä–µ–¥–∞–Ω –≤ VM
6. ‚úÖ NVIDIA –¥—Ä–∞–π–≤–µ—Ä—ã –≤ VM
7. ‚úÖ Ollama —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
8. ‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞
9. ‚úÖ n8n –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
10. üîÑ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
11. üîÑ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ HA Tools
12. üîÑ –ü–æ—Å–ª–µ –∞–ø–≥—Ä–µ–π–¥–∞ GPU —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ llama3.1:8b

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–ø—ã—Ç–∞)

### 1. ‚ö†Ô∏è ASRock –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–µ –ø–ª–∞—Ç—ã: IOMMU —Å–∫—Ä—ã—Ç –≤ —Å—Ç–∞—Ä—ã—Ö BIOS
**–ü—Ä–æ–±–ª–µ–º–∞:** –í BIOS –≤–µ—Ä—Å–∏–∏ P3.xx –æ–ø—Ü–∏—è IOMMU –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ BIOS –¥–æ P7.xx+ (—Å–º. –≠—Ç–∞–ø 1.3)

### 2. ‚ö†Ô∏è AMD –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã: –ø–∞—Ä–∞–º–µ—Ç—Ä amd_iommu=1 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–ü—Ä–æ–±–ª–µ–º–∞:** –í —è–¥—Ä–µ 6.8+ –ø–∞—Ä–∞–º–µ—Ç—Ä `amd_iommu=1` –≤—ã–∑—ã–≤–∞–µ—Ç "Unknown option"
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `amd_iommu=on` (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å)

### 3. ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ RAM –Ω–∞ —Ö–æ—Å—Ç–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** VM –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π "Cannot allocate memory"
**–†–µ—à–µ–Ω–∏–µ:** –£–º–µ–Ω—å—à–∏—Ç–µ RAM VM (—Å–º. –≠—Ç–∞–ø 4.5 –∏ Troubleshooting)

### 4. ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ cpu –≤ –∫–æ–Ω—Ñ–∏–≥–µ VM
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ `cpu: host`
**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—É—é —Å—Ç—Ä–æ–∫—É, –æ—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (—Å–º. –≠—Ç–∞–ø 6.2)

### 5. ‚ö†Ô∏è –ú–∞–π–Ω–∏–Ω–≥–æ–≤—ã–µ –∫–∞—Ä—Ç—ã: x-vga=1 –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã
**–ü—Ä–æ–±–ª–µ–º–∞:** P106/P104 –±–µ–∑ –≤–∏–¥–µ–æ–≤—ã—Ö–æ–¥–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å x-vga=1
**–†–µ—à–µ–Ω–∏–µ:** –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ x-vga=1 –¥–ª—è –º–∞–π–Ω–∏–Ω–≥–æ–≤—ã—Ö –∫–∞—Ä—Ç (—Å–º. –≠—Ç–∞–ø 6.1)

### 6. ‚ö†Ô∏è Ollama —Å–ª—É—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ 127.0.0.1
**–ü—Ä–æ–±–ª–µ–º–∞:** override.conf –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ (—Å–º. –≠—Ç–∞–ø 10.2, –í–∞—Ä–∏–∞–Ω—Ç B)

### 7. ‚úÖ EFI —Ä–∞–∑–¥–µ–ª –Ω–µ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ update-initramfs
**–†–µ—à–µ–Ω–∏–µ:** –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å /dev/sda2 –≤ /boot/efi

### 8. ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "Unknown option - 'on'" –¥–ª—è amd_iommu
**–ù–µ –ø—Ä–æ–±–ª–µ–º–∞:** AMD-Vi –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
**–î–µ–π—Å—Ç–≤–∏–µ:** –ò–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ, –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ IOMMU groups

---

**–ê–≤—Ç–æ—Ä:** AI Assistant (Proxmox DevOps Expert)
**–ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è:** Community Best Practices + Deep Proxmox Knowledge + Real Deployment Experience

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞:**
- **Proxmox VE:** 8.x (—è–¥—Ä–æ 6.8.12-4-pve)
- **Proxmox Host:** 192.168.1.124
- **CPU:** AMD Ryzen 5 2600 Six-Core (12 threads)
- **–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞:** ASRock B450M Pro4 (BIOS P7.40, –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å P3.50)
- **RAM:** 16GB (–æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å 8GB –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π)
- **GPU:** NVIDIA P106-100 (–º–∞–π–Ω–∏–Ω–≥–æ–≤–∞—è –∫–∞—Ä—Ç–∞, 6GB VRAM, –±–µ–∑ –≤–∏–¥–µ–æ–≤—ã—Ö–æ–¥–æ–≤)
- **VM ID:** 103 (ollama-vm)
- **VM IP:** 192.168.1.131
- **VM Resources:** Ubuntu 22.04.5 LTS, 4 cores, 10GB RAM, 64GB disk
- **Ollama:** –≤–µ—Ä—Å–∏—è 0.x.x —Å NVIDIA Driver 580.95.05, CUDA 13.0
- **–ú–æ–¥–µ–ª–∏:**
  - llama3.1:8b (4.7GB) - –æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å ‚úÖ
  - phi3:mini (2.3GB) - —Ä–µ–∑–µ—Ä–≤–Ω–∞—è
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** llama3.1:8b ~35-45 tokens/sec –Ω–∞ GPU
- **Whisper.cpp:** base –º–æ–¥–µ–ª—å CUDA –≤–µ—Ä—Å–∏—è ‚úÖ
  - 11 —Å–µ–∫ –∞—É–¥–∏–æ ‚Üí 0.56 —Å–µ–∫ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ (19x realtime)
  - API endpoint: http://192.168.1.131:9000
- –¢–∞–∫–∂–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å NVIDIA GTX/RTX 10xx-40xx series (–æ–±—ã—á–Ω—ã–µ –∫–∞—Ä—Ç—ã)

**–í–µ—Ä—Å–∏—è:** 1.3 (–æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å —Ä–µ–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π + Whisper)
**–î–∞—Ç–∞:** –ù–æ—è–±—Ä—å 8, 2025

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
**–í—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:** ~90 –º–∏–Ω—É—Ç (Ollama) + ~40 –º–∏–Ω—É—Ç (Whisper —Å CUDA)
**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- Ollama: GPU utilization 80-100% –≤–æ –≤—Ä–µ–º—è inference
- Whisper: 19x realtime —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –Ω–∞ GPU (0.56 —Å–µ–∫ –Ω–∞ 11 —Å–µ–∫ –∞—É–¥–∏–æ)
- **–û–±—â–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞:** 3-6 —Å–µ–∫ –æ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
