# Whisper.cpp ะดะปั Ollama VM - ะะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต ัะตัะธ

ะะพะฟะพะปะฝะตะฝะธะต ะบ ะพัะฝะพะฒะฝะพะผั ะณะฐะนะดั OLLAMA-PROXMOX-COMPLETE-GUIDE.md

**ะะพะฝัะธะณััะฐัะธั:**
- VM ID: 103 (ollama-vm)
- VM IP: 192.168.1.131
- Proxmox Host: 192.168.1.124
- GPU: NVIDIA P106-100 (6GB VRAM)

---

## ะะฐัะตะผ Whisper ะฒ ัะพะน ะถะต VM?

Whisper.cpp - ะปะพะบะฐะปัะฝัะน ะดะฒะธะถะพะบ ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั ัะตัะธ ะพั OpenAI:

**ะัะตะธะผััะตััะฒะฐ ัััะฐะฝะพะฒะบะธ ะฒ VM ั Ollama:**
- โ **ะัะฟะพะปัะทัะตั ัั ะถะต GPU** ะดะปั ััะบะพัะตะฝะธั ััะฐะฝัะบัะธะฑะฐัะธะธ
- โ **ะะตัะฟะปะฐัะฝะพ** (ะฑะตะท OpenAI API costs ~$0.006/ะผะธะฝ)
- โ **ะัะธะฒะฐัะฝะพััั** (ะณะพะปะพั ะฝะต ััะพะดะธั ะฒ ะพะฑะปะฐะบะพ)
- โ **ะััััะตะต** ัะตะผ ะพะฑะปะฐัะฝัะต API (ะปะพะบะฐะปัะฝะพ ะฝะฐ GPU)
- โ **ะะฝัะตะณัะฐัะธั ั n8n** ัะตัะตะท REST API

**ะะตััััั:**
- VRAM: ~0.5-1GB (CPU ะฒะตััะธั) ะธะปะธ ~1-2GB (CUDA ะฒะตััะธั)
- RAM: ~500MB-1GB
- ะะธัะบ: ~150MB (base ะผะพะดะตะปั)
- CPU: 4 ัะดัะฐ ะดะพััะฐัะพัะฝะพ

**ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั:**
- CPU ะฒะตััะธั: ~0.4x realtime (11 ัะตะบ ะฐัะดะธะพ โ 4.5 ัะตะบ ะพะฑัะฐะฑะพัะบะธ)
- CUDA ะฒะตััะธั: **~19x realtime** (11 ัะตะบ ะฐัะดะธะพ โ 0.56 ัะตะบ ะพะฑัะฐะฑะพัะบะธ) โ **ะัะพัะตััะธัะพะฒะฐะฝะพ ะฝะฐ P106-100**

---

## ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน

```bash
ssh gfer@192.168.1.131

sudo apt update
sudo apt install -y git build-essential cmake ffmpeg python3-pip python3-venv
```

---

## ะะปะพะฝะธัะพะฒะฐะฝะธะต ะธ ัะฑะพัะบะฐ Whisper.cpp

```bash
cd ~
git clone https://github.com/ggerganov/whisper.cpp
cd whisper.cpp

# ะกะบะฐัะฐัั ะผะพะดะตะปั base (ะพะฟัะธะผะฐะปัะฝะฐ ะดะปั ััััะบะพะณะพ ัะทัะบะฐ)
bash ./models/download-ggml-model.sh base

# ะัะพะฒะตัะบะฐ ััะพ ะผะพะดะตะปั ัะบะฐัะฐะปะฐัั
ls -lh models/ggml-base.bin
```

### ะะฐัะธะฐะฝั A: CPU ะฒะตััะธั (ัะตะบะพะผะตะฝะดัะตััั)

```bash
cd ~/whisper.cpp

# ะกะพะฑัะฐัั ะฑะตะท CUDA
cmake -B build
cmake --build build --config Release -j

# ะขะตัั
./build/bin/whisper-cli -m models/ggml-base.bin -f samples/jfk.wav
```

**ะะถะธะดะฐะตะผัะน ะฒัะฒะพะด:**
```text
[00:00:00.000 --> 00:00:10.600] And so my fellow Americans, ask not what your country can do for you, ask what you can do for your country.

whisper_print_timings: total time = 4474.89 ms
```

### ะะฐัะธะฐะฝั B: CUDA ะฒะตััะธั (ะดะปั GPU ััะบะพัะตะฝะธั)

**โ๏ธ ะขัะตะฑัะตั:**
- 16GB+ RAM ะฝะฐ ัะพััะต (ะบะพะผะฟะธะปััะธั ะพัะตะฝั ะฟัะพะถะพัะปะธะฒะฐั)
- CUDA toolkit ัััะฐะฝะพะฒะปะตะฝ ะฒ VM

**ะฃััะฐะฝะพะฒะบะฐ CUDA toolkit:**

```bash
# ะกะบะฐัะฐัั CUDA keyring
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
sudo dpkg -i cuda-keyring_1.1-1_all.deb

# ะฃััะฐะฝะพะฒะธัั CUDA 12.2
sudo apt update
sudo apt install -y cuda-toolkit-12-2

# ะะพะฑะฐะฒะธัั ะฒ PATH
echo 'export PATH=/usr/local/cuda-12.2/bin:$PATH' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH=/usr/local/cuda-12.2/lib64:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc

# ะัะพะฒะตัะบะฐ
nvcc --version
```

**ะกะฑะพัะบะฐ Whisper ั CUDA:**

```bash
cd ~/whisper.cpp
rm -rf build

export CUDA_HOME=/usr/local/cuda-12.2
export PATH=$CUDA_HOME/bin:$PATH
export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

# ะกะพะฑัะฐัั ะะะ -j (ะธะฝะฐัะต ัะฑััั ะฟัะพัะตัั ะธะท-ะทะฐ ะฝะตัะฒะฐัะบะธ RAM)
cmake -B build -DGGML_CUDA=ON
cmake --build build --config Release

# ะญัะพ ะทะฐะนะผะตั 20-30 ะผะธะฝัั
```

**ะัะพะฒะตัะบะฐ GPU ะฟะพะดะดะตัะถะบะธ:**

```bash
# ะัะพะฒะตัะธัั ััะพ ะฑะธะฝะฐัะฝะธะบ ะปะธะฝะบัะตััั ั CUDA
ldd build/bin/whisper-cli | grep cuda

# ะะพะปะถะฝะพ ะฟะพะบะฐะทะฐัั:
# libcudart.so.12 => /usr/local/cuda-12.2/lib64/libcudart.so.12

# ะขะตัั ั GPU
./build/bin/whisper-cli -m models/ggml-base.bin -f samples/jfk.wav

# ะ ะฒัะฒะพะดะต ะดะพะปะถะฝะพ ะฑััั:
# whisper_backend_init_gpu: device 0: NVIDIA P106-100
# (ะฒะผะตััะพ "device 0: CPU")
```

---

## ะกะพะทะดะฐะฝะธะต REST API ะดะปั n8n

ะกะพะทะดะฐะนัะต Flask API ัะตัะฒะตั:

```bash
# ะฃััะฐะฝะพะฒะธัั Flask
pip3 install flask

# ะะพะฑะฐะฒะธัั ะฒ PATH
echo 'export PATH=$HOME/.local/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# ะกะพะทะดะฐัั API ัะบัะธะฟั
nano ~/whisper-api.py
```

**ะกะพะดะตัะถะธะผะพะต ัะฐะนะปะฐ:**

```python
from flask import Flask, request, jsonify
import subprocess
import os
import tempfile

app = Flask(__name__)

WHISPER_PATH = "/home/gfer/whisper.cpp/build/bin/whisper-cli"
MODEL_PATH = "/home/gfer/whisper.cpp/models/ggml-base.bin"

@app.route('/transcribe', methods=['POST'])
def transcribe():
    if 'audio' not in request.files:
        return jsonify({'error': 'No audio file'}), 400

    audio_file = request.files['audio']

    # ะกะพััะฐะฝะธัั ะฒัะตะผะตะฝะฝะพ
    with tempfile.NamedTemporaryFile(delete=False, suffix='.wav') as tmp:
        audio_file.save(tmp.name)
        tmp_path = tmp.name

    try:
        # ะะฐะฟัััะธัั Whisper
        result = subprocess.run([
            WHISPER_PATH,
            '-m', MODEL_PATH,
            '-f', tmp_path,
            '--output-txt'
        ], capture_output=True, text=True, timeout=30)

        # ะัะพัะธัะฐัั ัะตะทัะปััะฐั
        txt_file = tmp_path + '.txt'
        if os.path.exists(txt_file):
            with open(txt_file, 'r') as f:
                text = f.read().strip()
            os.remove(txt_file)
        else:
            text = result.stdout

        os.remove(tmp_path)

        return jsonify({'text': text})

    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/health', methods=['GET'])
def health():
    return jsonify({'status': 'ok'})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=9000)
```

**ะกะพััะฐะฝะธัะต** (Ctrl+O, Enter, Ctrl+X)

---

## ะกะพะทะดะฐะฝะธะต systemd service

```bash
sudo nano /etc/systemd/system/whisper-api.service
```

**ะกะพะดะตัะถะธะผะพะต:**

```ini
[Unit]
Description=Whisper API Server
After=network.target

[Service]
Type=simple
User=gfer
WorkingDirectory=/home/gfer
ExecStart=/usr/bin/python3 /home/gfer/whisper-api.py
Restart=always
RestartSec=10
Environment="PATH=/home/gfer/.local/bin:/usr/local/bin:/usr/bin"

[Install]
WantedBy=multi-user.target
```

**ะะบัะธะฒะฐัะธั:**

```bash
# ะะฐะฟัััะธัั ัะตัะฒะธั
sudo systemctl daemon-reload
sudo systemctl enable whisper-api.service
sudo systemctl start whisper-api.service

# ะัะพะฒะตัะบะฐ
sudo systemctl status whisper-api.service
```

---

## ะขะตััะธัะพะฒะฐะฝะธะต API

```bash
# Health check
curl http://192.168.1.131:9000/health

# ะะพะปะถะฝะพ ะฒะตัะฝััั: {"status":"ok"}

# ะขะตัั ััะฐะฝัะบัะธะฑะฐัะธะธ ั ะปะพะบะฐะปัะฝัะผ ัะฐะนะปะพะผ
curl -X POST http://192.168.1.131:9000/transcribe \
  -F "audio=@samples/jfk.wav"

# ะะพะปะถะฝะพ ะฒะตัะฝััั JSON ั ัะตะบััะพะผ
```

**ะก Proxmox ัะพััะฐ ะธะปะธ n8n:**

```bash
curl http://192.168.1.131:9000/health
# {"status":"ok"}
```

---

## ะะฝัะตะณัะฐัะธั ั n8n

ะ n8n workflow ะดะพะฑะฐะฒััะต **HTTP Request** node:

**ะะปั Telegram ะณะพะปะพัะพะฒัั ัะพะพะฑัะตะฝะธะน:**

1. **Telegram Trigger** โ ะฟะพะปััะฐะตั ะณะพะปะพัะพะฒะพะต .ogg
2. **Convert Audio** (ะพะฟัะธะพะฝะฐะปัะฝะพ) โ .ogg โ .wav ัะตัะตะท ffmpeg
3. **HTTP Request** node:
   - Method: `POST`
   - URL: `http://192.168.1.131:9000/transcribe`
   - Body Content Type: `Form-Data`
   - Body Parameters:
     - Name: `audio`
     - Type: `File`
     - Value: `={{ $binary.data }}`
4. **Extract** โ `{{ $json.text }}`
5. **Ollama** โ ะพะฑัะฐะฑะพัะบะฐ ัะตะบััะฐ llama3.1:8b
6. **Telegram** โ ะพัะฒะตั ะฟะพะปัะทะพะฒะฐัะตะปั

**ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั (ัะตะฐะปัะฝัะต ะดะฐะฝะฝัะต ั P106-100):**
- 10 ัะตะบ ะณะพะปะพัะฐ โ **0.5 ัะตะบ ััะฐะฝัะบัะธะฑะฐัะธะธ** (CUDA) ๐
- + 2-5 ัะตะบ ะณะตะฝะตัะฐัะธะธ ะพัะฒะตัะฐ Ollama (llama3.1:8b)
- **ะัะพะณะพ:** 3-6 ัะตะบ ะพั ะณะพะปะพัะฐ ะดะพ ัะตะบััะพะฒะพะณะพ ะพัะฒะตัะฐ

**CPU ะฒะตััะธั** (ะตัะปะธ ะฝะต ัะดะฐะปะพัั ัะพะฑัะฐัั CUDA):
- 10 ัะตะบ ะณะพะปะพัะฐ โ 4-5 ัะตะบ ััะฐะฝัะบัะธะฑะฐัะธะธ (CPU)
- + 2-5 ัะตะบ ะณะตะฝะตัะฐัะธะธ ะพัะฒะตัะฐ Ollama
- **ะัะพะณะพ:** 6-10 ัะตะบ ะพั ะณะพะปะพัะฐ ะดะพ ัะตะบััะพะฒะพะณะพ ะพัะฒะตัะฐ

---

## ะะพะฝะธัะพัะธะฝะณ ะธ ะปะพะณะธ

```bash
# ะกัะฐััั API
sudo systemctl status whisper-api.service

# ะะพะณะธ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
sudo journalctl -u whisper-api.service -f

# ะะพะณะธ ะทะฐ ะฟะพัะปะตะดะฝะธะน ัะฐั
sudo journalctl -u whisper-api.service --since "1 hour ago"

# ะัะพะฒะตัะบะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ัะตััััะพะฒ
htop
# Whisper ะดะพะปะถะตะฝ ะฟะพะบะฐะทัะฒะฐัั ~25-50% CPU ะฟัะธ ััะฐะฝัะบัะธะฑะฐัะธะธ
```

---

## Troubleshooting

### ะัะพะฑะปะตะผะฐ: API ะฝะต ะพัะฒะตัะฐะตั

```bash
# ะัะพะฒะตัะธัั ััะพ ัะตัะฒะธั ะทะฐะฟััะตะฝ
sudo systemctl status whisper-api.service

# ะัะพะฒะตัะธัั ะฟะพัั
sudo ss -tlnp | grep 9000

# ะะตัะตะทะฐะฟัััะธัั
sudo systemctl restart whisper-api.service
```

### ะัะพะฑะปะตะผะฐ: ะะตะดะปะตะฝะฝะฐั ััะฐะฝัะบัะธะฑะฐัะธั

- CPU ะฒะตััะธั: 0.4x realtime - ััะพ ะฝะพัะผะฐะปัะฝะพ
- ะะฐััะผะพััะธัะต ัััะฐะฝะพะฒะบั CUDA ะฒะตััะธะธ (ะฒ 3-5 ัะฐะท ะฑััััะตะต)
- ะะปะธ ะธัะฟะพะปัะทัะนัะต ะผะพะดะตะปั tiny ะฒะผะตััะพ base (ะฑััััะตะต, ะฝะพ ััะถะต ะบะฐัะตััะฒะพ):
  ```bash
  bash ./models/download-ggml-model.sh tiny
  # ะะพะผะตะฝัะนัะต MODEL_PATH ะฒ whisper-api.py ะฝะฐ ggml-tiny.bin
  ```

### ะัะพะฑะปะตะผะฐ: CUDA ะฝะต ะธัะฟะพะปัะทัะตััั

```bash
# ะัะพะฒะตัะธัั ััะพ CUDA ัะพะฑัะฐะปะฐัั
ldd build/bin/whisper-cli | grep cuda

# ะัะพะฒะตัะธัั CUDA toolkit
nvcc --version

# ะะตัะตัะพะฑัะฐัั ัะฒะฝะพ
cd ~/whisper.cpp
rm -rf build
cmake -B build -DGGML_CUDA=ON
cmake --build build --config Release
```

### ะัะพะฑะปะตะผะฐ: Out of Memory ะฟัะธ CUDA ะบะพะผะฟะธะปััะธะธ

- ะะพะผะฟะธะปะธััะนัะต ะะะ `-j` ัะปะฐะณะฐ (ะฟะพ ะพะดะฝะพะผั ัะฐะนะปั)
- ะะปะธ ะธัะฟะพะปัะทัะนัะต CPU ะฒะตััะธั (ะฒะฟะพะปะฝะต ะฟัะธะตะผะปะตะผะฐ)
- ะัะตะผะตะฝะฝะพ ัะฒะตะปะธัััะต RAM VM ะดะพ 12-16GB ะดะปั ะบะพะผะฟะธะปััะธะธ:
  ```bash
  # ะะฐ Proxmox ัะพััะต
  qm shutdown 103
  qm set 103 --memory 16384
  qm start 103
  # ะะพัะปะต ะบะพะผะฟะธะปััะธะธ ะฒะตัะฝััั ะพะฑัะฐัะฝะพ
  qm shutdown 103
  qm set 103 --memory 10240
  qm start 103
  ```

---

## ะัะพะณะพะฒะฐั ะฐััะธัะตะบัััะฐ

```text
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Proxmox VE Host (192.168.1.124)            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ GPU: NVIDIA P106-100 โ vfio-pci        โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ              โ PCI Passthrough              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ Ubuntu VM (103): 192.168.1.131         โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ โ GPU: P106-100 (6GB VRAM)           โ โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ โ Ollama :11434                      โ โ โ
โ  โ โ llama3.1:8b (35-45 tok/s)          โ โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ โ Whisper API :9000                  โ โ โ
โ  โ โ base model (4.5s/11s audio)        โ โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  n8n โ Telegram Bot        โ
โ  ๐ค Voice โ AI โ HA         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะกัะฐััั:** โ CUDA ะฒะตััะธั ััะฟะตัะฝะพ ัะพะฑัะฐะฝะฐ ะธ ะฟัะพัะตััะธัะพะฒะฐะฝะฐ
**ะะฐัะฐ:** ะะพัะฑัั 8, 2025
**ะะตััะธั:** 1.1

---

## ะะตะทัะปััะฐัั ัะตััะธัะพะฒะฐะฝะธั (ัะตะฐะปัะฝัะต ะดะฐะฝะฝัะต)

### ะขะตัั 1: ะะฝะณะปะธะนัะบะธะน ัะตะบัั (samples/jfk.wav, 11 ัะตะบ)

**CUDA ะฒะตััะธั:**
```text
Device 0: NVIDIA P106-100, compute capability 6.1
whisper_backend_init_gpu: using CUDA0 backend

ะะตะทัะปััะฐั: "And so my fellow Americans ask not what your country can do for you,
            ask what you can do for your country."

ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั:
- encode time: 82.01 ms
- total time: 563.50 ms (0.56 ัะตะบ)
- ะกะบะพัะพััั: 19x realtime โ
```

**ะกัะฐะฒะฝะตะฝะธะต ั CPU ะฒะตััะธะตะน:**
```text
- CPU: 4474.89 ms (4.5 ัะตะบ)
- CUDA: 563.50 ms (0.56 ัะตะบ)
- ะฃัะบะพัะตะฝะธะต: 8x ะฑััััะตะต ๐
```

### ะขะตัั 2: ะัััะบะธะน ัะตะบัั (test-ru.wav, 2.2 ัะตะบ)

**CUDA ะฒะตััะธั:**
```text
ะะตะทัะปััะฐั: "ะะฐะฟัะธะผะตั, ัะตัะฝะตั ะฝะฐ ะบััะฝะต." (espeak-generated, ัะพัะฝะพััั ะผะพะถะตั ะฒะฐััะธัะพะฒะฐัััั)

ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั:
- encode time: 93.91 ms
- total time: 438.08 ms (0.44 ัะตะบ)
- ะกะบะพัะพััั: 5x realtime โ
```

### ะขะตัั 3: API ัะตัะตะท HTTP

```bash
curl -X POST http://192.168.1.131:9000/transcribe -F "audio=@samples/jfk.wav"
```

**ะะตะทัะปััะฐั:**
```json
{"text":"And so my fellow Americans ask not what your country can do for you, ask what you can do for your country."}
```

**ะัะตะผั ะพัะฒะตัะฐ:** ~1 ัะตะบ (ะฒะบะปััะฐั HTTP overhead)

---

## ะะพะฝัะธะณััะฐัะธั systemd service

**ะัะพะฒะตัะบะฐ ััะฐัััะฐ:**
```bash
sudo systemctl status whisper-api.service
```

**ะะถะธะดะฐะตะผัะน ะฒัะฒะพะด:**
```text
โ whisper-api.service - Whisper API Server
   Active: active (running)
   * Running on http://192.168.1.131:9000
```

**ะะฒัะพะทะฐะฟััะบ ะฟัะธ ะทะฐะณััะทะบะต:**
```bash
sudo systemctl enable whisper-api.service
```

---

## ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ

### Checklist ะฟะตัะตะด ะธะฝัะตะณัะฐัะธะตะน ั n8n:

- โ CUDA toolkit ัััะฐะฝะพะฒะปะตะฝ (`nvcc --version`)
- โ Whisper.cpp ัะพะฑัะฐะฝ ั CUDA (`ldd build/bin/whisper-cli | grep cuda`)
- โ GPU ะธัะฟะพะปัะทัะตััั (`whisper_backend_init_gpu: using CUDA0`)
- โ Flask API ะทะฐะฟััะตะฝ (`systemctl status whisper-api.service`)
- โ Health check ัะฐะฑะพัะฐะตั (`curl http://192.168.1.131:9000/health`)
- โ ะขัะฐะฝัะบัะธะฑะฐัะธั ัะฐะฑะพัะฐะตั (ัะตัั ัะตัะตะท curl)
- โ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั: 19x realtime ะฝะฐ GPU

**ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะบ production ะธัะฟะพะปัะทะพะฒะฐะฝะธั!** ๐

---

## ะฃะฟัะฐะฒะปะตะฝะธะต Home Assistant ัะตัะตะท ะณะพะปะพัะพะฒัะต ะบะพะผะฐะฝะดั

### n8n Workflow ั AI Tools

ะกะพะทะดะฐะฝ ัะฐััะธัะตะฝะฝัะน workflow: `n8n-voice-assistant-control-ollama.json`

**ะะพะฒัะต ะฒะพะทะผะพะถะฝะพััะธ:**
- ๐๏ธ **ะฃะฟัะฐะฒะปะตะฝะธะต ััััะพะนััะฒะฐะผะธ** ัะตัะตะท ะตััะตััะฒะตะฝะฝัะต ะบะพะผะฐะฝะดั
- ๐ง **AI Tools** - ะฐััะธััะตะฝั ัะฐะผ ะฒัะฑะธัะฐะตั ะฝัะถะฝัะน ะธะฝััััะผะตะฝั
- โ **ะะพะดัะฒะตัะถะดะตะฝะธะต ะดะตะนััะฒะธะน** - ะฑะพั ัะพะพะฑัะฐะตั ััะพ ัะดะตะปะฐะป

### ะะพัััะฟะฝัะต AI Tools

#### 1. **Control Device Tool** - ะะบะปััะตะฝะธะต/ะฒัะบะปััะตะฝะธะต
ะฃะฟัะฐะฒะปัะตั ััััะพะนััะฒะฐะผะธ (ัะฒะตั, ะฒัะบะปััะฐัะตะปะธ, ะบะปะธะผะฐั):

**ะัะธะผะตัั ะบะพะผะฐะฝะด:**
- ๐ค "ะะบะปััะธ ัะฒะตั ะฒ ะณะพััะธะฝะพะน"
- ๐ค "ะัะบะปััะธ ะบะพะฝะดะธัะธะพะฝะตั"
- ๐ค "ะะตัะตะบะปััะธ ะปััััั"

**ะะพะดะดะตัะถะธะฒะฐะตะผัะต ััััะพะนััะฒะฐ:**
- `light.*` - ะพัะฒะตัะตะฝะธะต
- `switch.*` - ะฒัะบะปััะฐัะตะปะธ/ัะพะทะตัะบะธ
- `climate.*` - ะบะปะธะผะฐั (on/off ะดะปั ัะตะถะธะผะพะฒ)
- `fan.*` - ะฒะตะฝัะธะปััะพัั
- `cover.*` - ะถะฐะปัะทะธ/ััะพัั

#### 2. **Set Device Value Tool** - ะฃััะฐะฝะพะฒะบะฐ ะทะฝะฐัะตะฝะธะน
ะะทะผะตะฝัะตั ะฟะฐัะฐะผะตััั ััััะพะนััะฒ:

**ะัะธะผะตัั ะบะพะผะฐะฝะด:**
- ๐ค "ะกะดะตะปะฐะน ะฟะพัััะต" (brightness ะดะปั ัะฒะตัะฐ)
- ๐ค "ะขะตะผะฟะตัะฐัััั ะฝะฐ 22 ะณัะฐะดััะฐ"
- ๐ค "ะะตะถะธะผ ะพะฑะพะณัะตะฒะฐ"

**ะะพะดะดะตัะถะธะฒะฐะตะผัะต ะฟะฐัะฐะผะตััั:**
- `brightness` (0-255) ะดะปั light
- `temperature` ะดะปั climate
- `hvac_mode` ะดะปั climate (heat, cool, auto, off)

#### 3. **Call Service Tool** - ะัะทะพะฒ ัะตัะฒะธัะพะฒ
ะะฐะฟััะบะฐะตั ััะตะฝะฐัะธะธ ะธ ะฐะฒัะพะผะฐัะธะทะฐัะธะธ:

**ะัะธะผะตัั ะบะพะผะฐะฝะด:**
- ๐ค "ะะบะปััะธ ัะตะถะธะผ ะบะธะฝะพ" (scene.turn_on)
- ๐ค "ะะฐะฟัััะธ ะดะพะฑัะพะต ัััะพ" (script.good_morning)

### ะะฐัััะพะนะบะฐ workflow

#### 1. ะะผะฟะพัั ะฒ n8n

```bash
# ะคะฐะนะป: docs/integrations/n8n-voice-assistant-control-ollama.json
```

#### 2. ะะฐัััะพะนะบะฐ Credentials

**Telegram Bot Token** (3 ะฝะพะดั):
- Telegram Trigger
- Send Command Response
- Send AI Response

**Home Assistant API**:
- Get HA States (ะธัะฟะพะปัะทัะตััั ะดะปั ััะตะฝะธั ัะพััะพัะฝะธะน)

**Home Assistant Token** (ะดะปั ัะฟัะฐะฒะปะตะฝะธั):
ะัะถะตะฝ ะฝะพะฒัะน credential ัะธะฟะฐ `HTTP Header Auth`:
- Header Name: `Authorization`
- Header Value: `Bearer YOUR_HA_LONG_LIVED_TOKEN`

ะะดะต ะฒะทััั ัะพะบะตะฝ:
1. Home Assistant โ Profile (ะปะตะฒัะน ะฝะธะถะฝะธะน ัะณะพะป)
2. ะัะพะบัััะธัั ะฒะฝะธะท ะดะพ "Long-Lived Access Tokens"
3. "Create Token" โ ะฝะฐะทะฒะฐัั "n8n Voice Control"
4. ะกะบะพะฟะธัะพะฒะฐัั ัะพะบะตะฝ

ะัะฟะพะปัะทัะตััั ะฒ ะฝะพะดะฐั:
- Execute Control
- Execute Set Value
- Execute Service

#### 3. ะัะพะฒะตัะบะฐ AI Agent

ะฃะฑะตะดะธัั ััะพ ะบ **AI Agent** ะฟะพะดะบะปััะตะฝั:
- **Chat Model**: Ollama Model
- **Memory**: Memory Buffer
- **Tools** (3 ัััะบะธ):
  - Tool: Control Device
  - Tool: Set Device Value
  - Tool: Call Service

### ะขะตััะธัะพะฒะฐะฝะธะต

#### ะขะตัั 1: ะฃะฟัะฐะฒะปะตะฝะธะต ัะฒะตัะพะผ

๐ค "ะะบะปััะธ ัะฒะตั ะฒ ะณะพััะธะฝะพะน"
- ะะถะธะดะฐะตััั: โ ะกะฒะตั ะฒะบะปััะธััั, ะฑะพั ะพัะฒะตัะธั "โ ะะบะปััะธะป ัะฒะตั ะฒ ะณะพััะธะฝะพะน"

๐ค "ะัะบะปััะธ ะปััััั"
- ะะถะธะดะฐะตััั: โ ะััััะฐ ะฒัะบะปััะธััั

๐ค "ะกะดะตะปะฐะน ะฟะพัััะต"
- ะะถะธะดะฐะตััั: โ ะฏัะบะพััั ัะฒะตะปะธัะธััั (ะตัะปะธ ัะฒะตั ะฑัะป ะฒะบะปััะตะฝ)

#### ะขะตัั 2: ะฃะฟัะฐะฒะปะตะฝะธะต ะบะปะธะผะฐัะพะผ

๐ค "ะขะตะผะฟะตัะฐัััั ะฝะฐ 22"
- ะะถะธะดะฐะตััั: โ ะขะตัะผะพััะฐั ัััะฐะฝะพะฒะธััั ะฝะฐ 22ยฐC

๐ค "ะะบะปััะธ ะพะฑะพะณัะตะฒ"
- ะะถะธะดะฐะตััั: โ ะะตะถะธะผ HVAC ะธะทะผะตะฝะธััั ะฝะฐ heat

#### ะขะตัั 3: ะัะบะปััะฐัะตะปะธ

๐ค "ะะบะปััะธ ะฒะตะฝัะธะปััะพั"
- ะะถะธะดะฐะตััั: โ ะัะบะปััะฐัะตะปั ะฒะตะฝัะธะปััะพัะฐ ะฒะบะปััะธััั

๐ค "ะัะบะปััะธ ัะพะทะตัะบั ะฝะฐ ะบััะฝะต"
- ะะถะธะดะฐะตััั: โ ะะพะทะตัะบะฐ ะฒัะบะปััะธััั

#### ะขะตัั 4: ะะพะฝัะตะบัั ะดะธะฐะปะพะณะฐ

๐ค "ะะบะปััะธ ัะฒะตั ะฒ ัะฟะฐะปัะฝะต"
- โ ะัะฒะตั: "ะะบะปััะธะป ัะฒะตั ะฒ ัะฟะฐะปัะฝะต"

๐ค "ะ ัะดะตะปะฐะน ะฟะพัะตะผะฝะตะต"
- โ ะัะฒะตั: "ะฃะผะตะฝััะธะป ััะบะพััั" (ะฟะพะผะฝะธั ััะพ ัะตัั ะพ ัะฒะตัะต ะฒ ัะฟะฐะปัะฝะต)

#### ะขะตัั 5: ะะฝัะพัะผะฐัะธะพะฝะฝัะต ะทะฐะฟัะพัั (ะฑะตะท ัะฟัะฐะฒะปะตะฝะธั)

๐ค "ะะฐะบะฐั ัะตะผะฟะตัะฐัััะฐ?"
- โ ะัะฒะตั: "๐ก๏ธ ะ ะดะพะผะต 21ยฐC..." (ัะพะปัะบะพ ะธะฝัะพัะผะฐัะธั, Tools ะฝะต ะธัะฟะพะปัะทััััั)

๐ค "ะงัะพ ัะตะนัะฐั ะฒะบะปััะตะฝะพ?"
- โ ะัะฒะตั: "๐ก ะะบะปััะตะฝะพ: ัะฒะตั ะฒ ะณะพััะธะฝะพะน..." (ะธะฝัะพัะผะฐัะธั)

### Troubleshooting

#### Tools ะฝะต ะฒัะทัะฒะฐัััั

**ะัะพะฑะปะตะผะฐ:** AI ะพัะฒะตัะฐะตั ัะตะบััะพะผ, ะฝะพ ะฝะต ะฒัะฟะพะปะฝัะตั ะดะตะนััะฒะธั

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัั ััะพ ะฒัะต 3 Tool ะฝะพะดั ะฟะพะดะบะปััะตะฝั ะบ AI Agent (ะฒัะพะด `Tools`)
2. ะฃะฑะตะดะธัั ััะพ ะฒ System Prompt ะตััั ะธะฝััััะบัะธะธ ะฟัะพ Tools
3. ะะพะฟัะพะฑัะน ะฑะพะปะตะต ัะฒะฝัะต ะบะพะผะฐะฝะดั: "ะฒะบะปััะธ ัะฒะตั ั entity_id light.living_room"

#### ะัะธะฑะบะฐ 401 Unauthorized

**ะัะพะฑะปะตะผะฐ:** `Execute Control/Value/Service` ะฒะพะทะฒัะฐัะฐะตั 401

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัั ััะพ credential "Home Assistant Token" ะฝะฐัััะพะตะฝ ะฟัะฐะฒะธะปัะฝะพ
2. ะัะพะฒะตัั ัะพะบะตะฝ ะฒ Home Assistant (Profile โ Long-Lived Access Tokens)
3. ะฃะฑะตะดะธัั ััะพ ัะพะบะตะฝ ะฝะต ะธัััะบ

#### Device not found

**ะัะพะฑะปะตะผะฐ:** AI ะณะพะฒะพัะธั ััะพ ััััะพะนััะฒะพ ะฝะต ะฝะฐะนะดะตะฝะพ

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัั ััะพ ััััะพะนััะฒะพ ะตััั ะฒ Home Assistant
2. ะัะพะฒะตัั entity_id ััััะพะนััะฒะฐ (Developer Tools โ States)
3. ะฃะฑะตะดะธัั ััะพ ััััะพะนััะฒะพ ะฒ ัะฟะธัะบะต "ะฃะฟัะฐะฒะปัะตะผัะต ััััะพะนััะฒะฐ" ะฒ ะบะพะฝัะตะบััะต AI

#### AI ะฝะต ะฟะพะฝะธะผะฐะตั ะบะพะผะฐะฝะดั

**ะัะพะฑะปะตะผะฐ:** AI ะฝะต ะฟะพะฝะธะผะฐะตั ะบะฐะบะพะต ะดะตะนััะฒะธะต ะฝัะถะฝะพ

**ะะตัะตะฝะธะต:**
1. ะัะฟะพะปัะทัะน ะฑะพะปะตะต ัะฒะฝัะต ะบะพะผะฐะฝะดั: "ะฒะบะปััะธ ัะฒะตั" ะฒะผะตััะพ "ัะฒะตั"
2. ะฃะบะฐะทัะฒะฐะน ะธะผั ััััะพะนััะฒะฐ ะบะฐะบ ะฒ Home Assistant
3. ะัะฟัะฐะฒั `/clear` ะดะปั ะพัะธััะบะธ ะบะพะฝัะตะบััะฐ

### ะกะฟะธัะพะบ ัะฟัะฐะฒะปัะตะผัั ััััะพะนััะฒ

ะขะตะบััะธะต ััััะพะนััะฒะฐ ะฒ Home Assistant (ะฒัะดะตัะถะบะฐ):

**ะกะฒะตั (light):**
- `light.esp32cam_light` - Tasmota cam
- `light.athom_ws2812b` - RGB ะปะตะฝัะฐ
- `light.birdbox_infrared` - ะะ ะฟะพะดัะฒะตัะบะฐ ัะบะฒะพัะตัะฝะธะบะฐ

**ะัะบะปััะฐัะตะปะธ (switch):**
- `switch.sonoff_100169e371_1` - ะััััั
- `switch.sonoff_100169e371_2` - ะัะฐ
- `switch.sonoff_100169e371_3` - ะคะฐัะฐะด
- `switch.sonoff_10001f3363` - ะััะฝั
- `switch.sonoff_ac0800382c` - ะะพะทะตัะบะฐ
- `switch.teplyi_pol` - ะขัะฟะปัะน ะฟะพะป

**ะะปะธะผะฐั (climate):**
- `climate.warming_floor_smart` - ะฃะผะฝัะน ััะฟะปัะน ะฟะพะป
- `climate.children_termostat` - ะะตััะบะฐั ัะตัะผะพััะฐั
- `climate.kitchen_termostat` - ะััะฝั ัะตัะผะพััะฐั
- `climate.living_room_termostat_2` - ะะพััะธะฝะฐั ัะตัะผะพััะฐั
- `climate.bedroom_termostat_2` - ะกะฟะฐะปัะฝั ัะตัะผะพััะฐั

**ะกัะตะฝะฐัะธะธ (scene):**
- `scene.tv` - ะะตะถะธะผ ะขะ

### ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

**ะขะธะฟะธัะฝะพะต ะฒัะตะผั ะพะฑัะฐะฑะพัะบะธ ะณะพะปะพัะพะฒะพะน ะบะพะผะฐะฝะดั:**
1. Whisper ััะฐะฝัะบัะธะฑะฐัะธั: **0.5-1 ัะตะบ** (CUDA)
2. Home Assistant state fetch: **0.2-0.5 ัะตะบ**
3. Ollama AI Agent + Tool: **2-4 ัะตะบ**
4. ะัะฟะพะปะฝะตะฝะธะต ะบะพะผะฐะฝะดั HA: **0.1-0.3 ัะตะบ**

**ะัะพะณะพ:** ~3-6 ัะตะบัะฝะด ะพั ะณะพะปะพัะพะฒะพะณะพ ัะพะพะฑัะตะฝะธั ะดะพ ะฒัะฟะพะปะฝะตะฝะธั ะบะพะผะฐะฝะดั โ

### ะะตะทะพะฟะฐัะฝะพััั

**ะะณัะฐะฝะธัะตะฝะธั:**
- Tools ัะฐะฑะพัะฐัั ัะพะปัะบะพ ั ััััะพะนััะฒะฐะผะธ ะธะท ะบะพะฝัะตะบััะฐ (ะฝะต ะผะพะณัั ัะฟัะฐะฒะปััั ัะธััะตะผะพะน HA)
- ะะตั ะดะพัััะฟะฐ ะบ ะบัะธัะธัะฝัะผ ัะตัะฒะธัะฐะผ (homeassistant.restart, etc)
- ะัะต ะดะตะนััะฒะธั ะปะพะณะธัััััั ะฒ n8n Executions
- ะขะพะบะตะฝ ะผะพะถะฝะพ ะพัะพะทะฒะฐัั ะฒ ะปัะฑะพะน ะผะพะผะตะฝั ะฒ Home Assistant

**ะะตะบะพะผะตะฝะดะฐัะธะธ:**
- ะัะฟะพะปัะทัะน ะพัะดะตะปัะฝัะน Long-Lived Token ัะพะปัะบะพ ะดะปั n8n
- ะะฐะทะพะฒะธ ะตะณะพ ะฟะพะฝััะฝะพ: "n8n Voice Control"
- ะะตะณัะปััะฝะพ ะฟัะพะฒะตััะน ะปะพะณะธ n8n Executions
- ะัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ ะดะพะฑะฐะฒั whitelist ััััะพะนััะฒ ะฒ ะฟัะพะผะฟั AI

---

**ะะพะปะพัะพะฒะพะน ะฐััะธััะตะฝั ั ัะฟัะฐะฒะปะตะฝะธะตะผ ะณะพัะพะฒ! ๐๐๏ธ**
