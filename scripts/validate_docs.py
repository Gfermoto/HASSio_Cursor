#!/usr/bin/env python3
"""
–í–∞–ª–∏–¥–∞—Ç–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ V2
–ò–°–ü–†–ê–í–õ–ï–ù–ê –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: —Ä–∞–∑–ª–∏—á–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏—Ö –∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö fence markers
"""

import re
import sys
from pathlib import Path
from typing import List, Tuple

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED = '\033[91m'
GREEN = '\033[92m'
YELLOW = '\033[93m'
BLUE = '\033[94m'
RESET = '\033[0m'
BOLD = '\033[1m'


class DocValidator:
    """–í–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"""

    def __init__(self, project_root: Path):
        self.project_root = project_root
        self.errors = []
        self.warnings = []
        self.total_files = 0
        self.checked_files = 0

    def validate_all(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é"""
        print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
        print("‚ïë           üîç –í–ê–õ–ò–î–ê–¶–ò–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò V2 üîç                        ‚ïë")
        print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
        print()

        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ Markdown —Ñ–∞–π–ª—ã
        md_files = self._find_markdown_files()
        self.total_files = len(md_files)

        if not md_files:
            print("‚ö†Ô∏è  Markdown —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return True

        print(f"üìä –ù–∞–π–¥–µ–Ω–æ Markdown —Ñ–∞–π–ª–æ–≤: {self.total_files}")
        print()
        print("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
        print()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
        for md_file in md_files:
            self._validate_file(md_file)

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        self._print_results()

        return len(self.errors) == 0

    def _find_markdown_files(self) -> List[Path]:
        """–ù–∞–π—Ç–∏ –≤—Å–µ Markdown —Ñ–∞–π–ª—ã"""
        md_files = []

        # –ò—Å–∫–ª—é—á–∞–µ–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        exclude_dirs = {
            '.git', 'node_modules', '__pycache__',
            '.venv', 'venv', 'audits', 'backups',
            '.storage', 'deps', 'tts'
        }

        for md_file in self.project_root.rglob('*.md'):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –≤ –∏—Å–∫–ª—é—á–∞–µ–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö
            if any(excluded in md_file.parts for excluded in exclude_dirs):
                continue
            md_files.append(md_file)

        return sorted(md_files)

    def _validate_file(self, filepath: Path):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–¥–∏–Ω —Ñ–∞–π–ª"""
        rel_path = filepath.relative_to(self.project_root)

        try:
            content = filepath.read_text(encoding='utf-8')
            lines = content.split('\n')

            # –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
            file_errors = []

            # –ü–†–û–í–ï–†–ö–ê 1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ fence markers (```text –≤–º–µ—Å—Ç–æ ```)
            file_errors.extend(self._check_wrong_fence_markers(lines, rel_path))

            # –ü–†–û–í–ï–†–ö–ê 2: –ù–µ–∑–∞–∫—Ä—ã—Ç—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞
            file_errors.extend(self._check_unclosed_code_blocks(lines, rel_path))

            # –ü–†–û–í–ï–†–ö–ê 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏
            file_errors.extend(self._check_missing_newline_between_blocks(lines, rel_path))

            # –ü–†–û–í–ï–†–ö–ê 4: Hardcoded –ø—É—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            file_errors.extend(self._check_hardcoded_paths(lines, rel_path))

            if file_errors:
                print(f"üìÑ {rel_path} ... {RED}‚ùå –û–®–ò–ë–ö–ò!{RESET}")
                for error in file_errors:
                    self.errors.append(error)
                    print(f"   {RED}‚Ä¢{RESET} {error}")
                print()
            else:
                print(f"üìÑ {rel_path} ... {GREEN}‚úÖ{RESET}")

            self.checked_files += 1

        except Exception as e:
            error = f"{rel_path}: –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}"
            self.errors.append(error)
            print(f"üìÑ {rel_path} ... {RED}‚ùå –û–®–ò–ë–ö–ê –ß–¢–ï–ù–ò–Ø!{RESET}")

    def _check_wrong_fence_markers(self, lines: List[str], filepath: Path) -> List[str]:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ fence markers (```text –≤–º–µ—Å—Ç–æ ```)"""
        errors = []
        in_code_block = False
        opening_line = 0

        for i, line in enumerate(lines):
            stripped = line.strip()

            # –û—Ç–∫—Ä—ã–≤–∞—é—â–∏–π fence: ```—è–∑—ã–∫
            if re.match(r'^```[a-z]+', stripped):
                if in_code_block:
                    # –û—à–∏–±–∫–∞: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞!
                    errors.append(
                        f"–°—Ç—Ä–æ–∫–∞ {i + 1}: –û—Ç–∫—Ä—ã–≤–∞—é—â–∏–π fence {stripped} –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ "
                        f"(–Ω–∞—á–∞—Ç–æ–≥–æ –Ω–∞ —Å—Ç—Ä–æ–∫–µ {opening_line + 1})"
                    )
                else:
                    in_code_block = True
                    opening_line = i

            # –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–π fence: –¢–û–õ–¨–ö–û ```
            elif stripped == '```':
                if not in_code_block:
                    errors.append(
                        f"–°—Ç—Ä–æ–∫–∞ {i + 1}: –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–π ``` –±–µ–∑ –æ—Ç–∫—Ä—ã–≤–∞—é—â–µ–≥–æ –±–ª–æ–∫–∞"
                    )
                else:
                    in_code_block = False

            # –û–®–ò–ë–ö–ê: ```—Ç–µ–∫—Å—Ç (–Ω–µ —è–∑—ã–∫, –∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)
            elif stripped.startswith('```') and len(stripped) > 3:
                # –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—à–∏–±–æ—á–Ω—ã–π fence –≤—Ä–æ–¥–µ ```text –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
                if in_code_block:
                    # –≠—Ç–æ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ - –≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞
                    pass
                else:
                    # –≠—Ç–æ –≤–Ω–µ –±–ª–æ–∫–∞ - –û–®–ò–ë–ö–ê!
                    errors.append(
                        f"–°—Ç—Ä–æ–∫–∞ {i + 1}: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π fence marker '{stripped}' "
                        f"(–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å '```—è–∑—ã–∫' –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∏–ª–∏ '```' –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è)"
                    )

        return errors

    def _check_unclosed_code_blocks(self, lines: List[str], filepath: Path) -> List[str]:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞"""
        errors = []
        in_code_block = False
        opening_line = 0

        for i, line in enumerate(lines):
            stripped = line.strip()

            # –û—Ç–∫—Ä—ã–≤–∞—é—â–∏–π: ```—è–∑—ã–∫
            if re.match(r'^```[a-z]+', stripped):
                in_code_block = True
                opening_line = i

            # –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–π: ```
            elif stripped == '```':
                in_code_block = False

        if in_code_block:
            errors.append(
                f"–ù–µ–∑–∞–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ –∫–æ–¥–∞ –Ω–∞—á–∞—Ç—ã–π –Ω–∞ —Å—Ç—Ä–æ–∫–µ {opening_line + 1}"
            )

        return errors

    def _check_missing_newline_between_blocks(self, lines: List[str], filepath: Path) -> List[str]:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ –µ—Å—Ç—å –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞"""
        errors = []
        prev_closing = -1

        for i, line in enumerate(lines):
            stripped = line.strip()

            # –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–π fence
            if stripped == '```':
                prev_closing = i

            # –û—Ç–∫—Ä—ã–≤–∞—é—â–∏–π fence
            elif re.match(r'^```[a-z]+', stripped):
                # –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π –±—ã–ª –Ω–∞ i-1, –∑–Ω–∞—á–∏—Ç –Ω–µ—Ç –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
                if prev_closing == i - 1:
                    errors.append(
                        f"–°—Ç—Ä–æ–∫–∞ {i + 1}: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞ "
                        f"(–ø–æ—Å–ª–µ ``` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–µ—Ä–µ–¥ {stripped})"
                    )

        return errors

    def _check_hardcoded_paths(self, lines: List[str], filepath: Path) -> List[str]:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ hardcoded –ø—É—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        errors = []
        in_code_block = False

        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
        patterns = [
            (r'/home/[a-z]+/', '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ~ –≤–º–µ—Å—Ç–æ /home/username/'),
            (r'/Users/[A-Za-z]+/', '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ~ –≤–º–µ—Å—Ç–æ /Users/username/'),
        ]

        for i, line in enumerate(lines):
            stripped = line.strip()

            # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞
            if re.match(r'^```[a-z]*$', stripped):
                in_code_block = not in_code_block
                continue

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–æ–≤
            if in_code_block:
                continue

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –≥–¥–µ —ç—Ç–æ –ø—Ä–∏–º–µ—Ä –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
            if '–≤–º–µ—Å—Ç–æ' in line.lower() or '~/path' in line or '~/' in line:
                continue

            for pattern, message in patterns:
                if re.search(pattern, line):
                    match = re.search(pattern, line)
                    errors.append(
                        f"–°—Ç—Ä–æ–∫–∞ {i + 1}: Hardcoded –ø—É—Ç—å '{match.group()}' - {message}"
                    )

        return errors

    def _print_results(self):
        """–í—ã–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"""
        print()
        print("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
        print()
        print("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:")
        print(f"   –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {self.checked_files}")
        print(f"   {GREEN}‚úÖ –ë–µ–∑ –æ—à–∏–±–æ–∫:    {self.checked_files - len(set(e.split(':')[0] for e in self.errors))}{RESET}")
        print(f"   {RED}‚ùå –° –æ—à–∏–±–∫–∞–º–∏:    {len(set(e.split(':')[0] for e in self.errors))}{RESET}")

        if self.warnings:
            print(f"   {YELLOW}‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: {len(self.warnings)}{RESET}")

        print()

        if not self.errors:
            print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
            print("‚ïë           ‚úÖ –í–°–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –í–ê–õ–ò–î–ù–ê! ‚úÖ                        ‚ïë")
            print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
        else:
            print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
            print("‚ïë        ‚ùå –û–ë–ù–ê–†–£–ñ–ï–ù–´ –û–®–ò–ë–ö–ò –í –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò! ‚ùå                  ‚ïë")
            print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
            print()
            print("üí° –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É —Å–Ω–æ–≤–∞")
            print()


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
    script_dir = Path(__file__).parent
    project_root = script_dir.parent

    # –°–æ–∑–¥–∞–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä
    validator = DocValidator(project_root)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
    success = validator.validate_all()

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–¥ –≤—ã—Ö–æ–¥–∞
    sys.exit(0 if success else 1)


if __name__ == '__main__':
    main()
