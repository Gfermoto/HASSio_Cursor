#!/usr/bin/env python3
"""
–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ä–∞–∑–ª–∏—á–∏–π –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏ –∫–∞–∫–æ–µ –≤–ª–∏—è–Ω–∏–µ —ç—Ç–æ –æ–∫–∞–∂–µ—Ç
"""

import yaml
import subprocess
from pathlib import Path
from typing import Dict, List, Any, Set
from collections import defaultdict


class ConfigDiff:
    """–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ä–∞–∑–ª–∏—á–∏–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π"""

    def __init__(self, config_dir: str):
        self.config_dir = Path(config_dir)
        self.changes = defaultdict(list)

    def compare_commits(self, commit1: str = 'HEAD~1', commit2: str = 'HEAD') -> Dict[str, Any]:
        """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è –∫–æ–º–º–∏—Ç–∞–º–∏"""
        print(f"üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: {commit1} ‚Üí {commit2}")

        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        try:
            result = subprocess.run(
                ['git', 'diff', '--name-status', commit1, commit2],
                cwd=self.config_dir.parent,
                capture_output=True,
                text=True,
                check=True
            )

            changed_files = result.stdout.strip().split('\n')

        except subprocess.CalledProcessError as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ git diff: {e}")
            return {}

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        for line in changed_files:
            if not line:
                continue

            parts = line.split('\t')
            if len(parts) < 2:
                continue

            status = parts[0]
            filepath = parts[1]

            # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            if not (filepath.endswith('.yaml') or filepath.endswith('.yml')):
                continue

            if filepath.startswith('config/'):
                self._analyze_file_change(status, filepath, commit1, commit2)

        return self._generate_report()

    def _analyze_file_change(self, status: str, filepath: str, commit1: str, commit2: str):
        """–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ñ–∞–π–ª–µ"""
        change_type = {
            'A': 'added',
            'M': 'modified',
            'D': 'deleted',
            'R': 'renamed'
        }.get(status[0], 'unknown')

        # –ü–æ–ª—É—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤
        try:
            # –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è
            if change_type != 'added':
                old_content = subprocess.run(
                    ['git', 'show', f'{commit1}:{filepath}'],
                    cwd=self.config_dir.parent,
                    capture_output=True,
                    text=True
                ).stdout
                old_data = yaml.safe_load(old_content) if old_content else {}
            else:
                old_data = {}

            # –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
            if change_type != 'deleted':
                new_content = subprocess.run(
                    ['git', 'show', f'{commit2}:{filepath}'],
                    cwd=self.config_dir.parent,
                    capture_output=True,
                    text=True
                ).stdout
                new_data = yaml.safe_load(new_content) if new_content else {}
            else:
                new_data = {}

            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            self._compare_yaml_data(filepath, old_data, new_data, change_type)

        except Exception as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ {filepath}: {e}")

    def _compare_yaml_data(self, filepath: str, old_data: Any, new_data: Any, change_type: str):
        """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ YAML –¥–∞–Ω–Ω—ã—Ö"""
        filename = Path(filepath).name

        if filename == 'automations.yaml':
            self._compare_automations(old_data, new_data, change_type)
        elif filename == 'scripts.yaml':
            self._compare_scripts(old_data, new_data, change_type)
        elif filename in ['sensors.yaml', 'binary_sensors.yaml']:
            self._compare_sensors(old_data, new_data, change_type)
        else:
            # –û–±—â–µ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
            self.changes['other'].append({
                'file': filepath,
                'change_type': change_type
            })

    def _compare_automations(self, old_data: List, new_data: List, change_type: str):
        """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π"""
        old_automations = {a.get('id') or a.get('alias'): a for a in (old_data or [])}
        new_automations = {a.get('id') or a.get('alias'): a for a in (new_data or [])}

        # –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ
        for auto_id in set(new_automations) - set(old_automations):
            self.changes['automations_added'].append({
                'id': auto_id,
                'alias': new_automations[auto_id].get('alias'),
                'data': new_automations[auto_id]
            })

        # –£–¥–∞–ª–µ–Ω–Ω—ã–µ
        for auto_id in set(old_automations) - set(new_automations):
            self.changes['automations_deleted'].append({
                'id': auto_id,
                'alias': old_automations[auto_id].get('alias'),
                'severity': 'high'  # –£–¥–∞–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ - –≤–∞–∂–Ω–æ!
            })

        # –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ
        for auto_id in set(old_automations) & set(new_automations):
            if old_automations[auto_id] != new_automations[auto_id]:
                diff_details = self._find_automation_differences(
                    old_automations[auto_id],
                    new_automations[auto_id]
                )
                self.changes['automations_modified'].append({
                    'id': auto_id,
                    'alias': new_automations[auto_id].get('alias'),
                    'changes': diff_details
                })

    def _find_automation_differences(self, old_auto: Dict, new_auto: Dict) -> List[str]:
        """–ù–∞—Ö–æ–¥–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏"""
        differences = []

        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–µ–∫—Ü–∏–∏
        for section in ['trigger', 'condition', 'action']:
            old_section = yaml.dump(old_auto.get(section, {}))
            new_section = yaml.dump(new_auto.get(section, {}))

            if old_section != new_section:
                differences.append(f"–ò–∑–º–µ–Ω–µ–Ω {section}")

        return differences

    def _compare_scripts(self, old_data: Dict, new_data: Dict, change_type: str):
        """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤"""
        old_scripts = set(old_data.keys()) if old_data else set()
        new_scripts = set(new_data.keys()) if new_data else set()

        # –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ
        for script_id in new_scripts - old_scripts:
            self.changes['scripts_added'].append({'id': script_id})

        # –£–¥–∞–ª–µ–Ω–Ω—ã–µ
        for script_id in old_scripts - new_scripts:
            self.changes['scripts_deleted'].append({
                'id': script_id,
                'severity': 'medium'
            })

        # –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ
        for script_id in old_scripts & new_scripts:
            if old_data[script_id] != new_data[script_id]:
                self.changes['scripts_modified'].append({'id': script_id})

    def _compare_sensors(self, old_data: List, new_data: List, change_type: str):
        """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–µ–Ω—Å–æ—Ä–æ–≤"""
        old_sensors = {s.get('unique_id') or s.get('name'): s for s in (old_data or []) if isinstance(s, dict)}
        new_sensors = {s.get('unique_id') or s.get('name'): s for s in (new_data or []) if isinstance(s, dict)}

        # –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ
        for sensor_id in set(new_sensors) - set(old_sensors):
            self.changes['sensors_added'].append({'id': sensor_id})

        # –£–¥–∞–ª–µ–Ω–Ω—ã–µ
        for sensor_id in set(old_sensors) - set(new_sensors):
            self.changes['sensors_deleted'].append({
                'id': sensor_id,
                'severity': 'high'  # –ú–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏!
            })

        # –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ
        for sensor_id in set(old_sensors) & set(new_sensors):
            if old_sensors[sensor_id] != new_sensors[sensor_id]:
                self.changes['sensors_modified'].append({'id': sensor_id})

    def _generate_report(self) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö"""
        total_changes = sum(len(v) for v in self.changes.values())

        # –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞
        risk_score = 0
        warnings = []

        # –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä—ã - –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫
        if self.changes['sensors_deleted']:
            risk_score += len(self.changes['sensors_deleted']) * 10
            warnings.append(
                f"‚ö†Ô∏è  –£–¥–∞–ª–µ–Ω–æ {len(self.changes['sensors_deleted'])} —Å–µ–Ω—Å–æ—Ä–æ–≤ - "
                "–º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏!"
            )

        # –£–¥–∞–ª–µ–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
        if self.changes['automations_deleted']:
            risk_score += len(self.changes['automations_deleted']) * 5
            warnings.append(
                f"‚ö†Ô∏è  –£–¥–∞–ª–µ–Ω–æ {len(self.changes['automations_deleted'])} –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π"
            )

        # –ú–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        if total_changes > 20:
            risk_score += 10
            warnings.append(f"‚ö†Ô∏è  –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π ({total_changes})")

        risk_level = 'low'
        if risk_score > 50:
            risk_level = 'critical'
        elif risk_score > 20:
            risk_level = 'high'
        elif risk_score > 5:
            risk_level = 'medium'

        return {
            'total_changes': total_changes,
            'changes': dict(self.changes),
            'risk_score': risk_score,
            'risk_level': risk_level,
            'warnings': warnings
        }


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    import sys

    config_dir = sys.argv[1] if len(sys.argv) > 1 else 'config'
    commit1 = sys.argv[2] if len(sys.argv) > 2 else 'HEAD~1'
    commit2 = sys.argv[3] if len(sys.argv) > 3 else 'HEAD'

    print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
    print("‚ïë              üîÑ –ê–ù–ê–õ–ò–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò üîÑ                 ‚ïë")
    print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
    print()

    analyzer = ConfigDiff(config_dir)
    report = analyzer.compare_commits(commit1, commit2)

    if not report:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è")
        return

    changes = report['changes']

    print(f"üìä –í—Å–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π: {report['total_changes']}")
    print(f"üéØ –£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞: {report['risk_level'].upper()} (score: {report['risk_score']})")
    print()

    # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
    if changes.get('automations_added'):
        print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π: {len(changes['automations_added'])}")
        for auto in changes['automations_added'][:5]:
            print(f"   ‚Ä¢ {auto.get('alias', auto['id'])}")
        print()

    if changes.get('automations_deleted'):
        print(f"üî¥ –£–¥–∞–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π: {len(changes['automations_deleted'])}")
        for auto in changes['automations_deleted']:
            print(f"   ‚Ä¢ {auto.get('alias', auto['id'])}")
        print()

    if changes.get('automations_modified'):
        print(f"üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π: {len(changes['automations_modified'])}")
        for auto in changes['automations_modified'][:5]:
            print(f"   ‚Ä¢ {auto.get('alias', auto['id'])}")
            for change in auto.get('changes', []):
                print(f"      - {change}")
        print()

    # –°–µ–Ω—Å–æ—Ä—ã
    if changes.get('sensors_deleted'):
        print(f"üî¥ –£–¥–∞–ª–µ–Ω–æ —Å–µ–Ω—Å–æ—Ä–æ–≤: {len(changes['sensors_deleted'])}")
        for sensor in changes['sensors_deleted']:
            print(f"   ‚Ä¢ {sensor['id']}")
        print()

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    if report['warnings']:
        print("‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø:")
        for warning in report['warnings']:
            print(f"   {warning}")
        print()

    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    if report['risk_level'] in ['high', 'critical']:
        print("üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
        print("   ‚Ä¢ –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º")
        print("   ‚Ä¢ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ dev-–æ–∫—Ä—É–∂–µ–Ω–∏–∏")
        print("   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π")
        print()


if __name__ == '__main__':
    main()
