#!/bin/bash
# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Home Assistant

set -e

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—É—Ç–∏
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib_paths.sh"

echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Home Assistant"
echo "==========================================="
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ config —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
CONFIG_LINK="$PROJECT_ROOT/config"
if [ ! -d "$CONFIG_LINK" ]; then
    echo "‚ùå Config –Ω–µ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: $SCRIPTS_DIR/mount.sh"
    exit 1
fi

# 2. –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –ü–ï–†–ï–î –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
echo "1Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
"$SCRIPTS_DIR/backup.sh"
echo ""

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ YAML —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ YAML —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
if command -v yamllint &> /dev/null; then
    if yamllint config/*.yaml 2>/dev/null; then
        echo "‚úÖ YAML —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
    else
        echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è YAML (–º–æ–∂–Ω–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å)"
    fi
else
    echo "‚ö†Ô∏è  yamllint –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ HA
echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Home Assistant..."
if ssh -F .ssh/config hassio "ha core check" 2>&1 | tee /tmp/ha_check.log; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Home Assistant –≤–∞–ª–∏–¥–Ω–∞"
else
    echo "‚ùå –û–®–ò–ë–ö–ê –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Home Assistant!"
    echo ""
    cat /tmp/ha_check.log
    echo ""
    read -p "–í—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"
        echo "üí° –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
        exit 1
    fi
fi
echo ""

# 5. Git –∫–æ–º–º–∏—Ç (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
if [ -d config/.git ]; then
    echo "4Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Git..."
    cd config/
    
    if git diff --quiet && git diff --cached --quiet; then
        echo "‚ö†Ô∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
    else
        git add -A
        
        echo "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞ (–∏–ª–∏ Enter –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ):"
        read -r COMMIT_MSG
        
        if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="Config update $(date '+%Y-%m-%d %H:%M')"
        fi
        
        git commit -m "$COMMIT_MSG"
        echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Git"
    fi
    
    cd ..
    echo ""
fi

# 6. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ HA
echo "5Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Home Assistant..."
read -p "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å HA? (y/N): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
    echo "üí° –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –Ω–æ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    exit 0
fi

echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Home Assistant Core..."
ssh -F .ssh/config hassio "ha core restart"

echo ""
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (30 —Å–µ–∫—É–Ω–¥)..."
for i in {30..1}; do
    echo -ne "   $i —Å–µ–∫—É–Ω–¥...\r"
    sleep 1
done
echo ""

# 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ HA –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏..."
sleep 5

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib_config.sh"

if curl -sf -m 10 "$HA_URL" > /dev/null 2>&1; then
    echo "‚úÖ Home Assistant –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ö†Ô∏è  Home Assistant –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: ./scripts/view_logs.sh"
fi

echo ""
echo "==========================================="
echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "==========================================="
echo ""
echo "üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:"
echo "   1. ‚úÖ –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø"
echo "   2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω YAML"
echo "   3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è HA"
echo "   4. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –≤ Git"
echo "   5. ‚úÖ Home Assistant –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: ./scripts/view_logs.sh"
echo "   - –û—Ç–∫—Ä–æ–π—Ç–µ HA: $HA_URL"
echo "   - –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å: ./scripts/restore.sh"
echo ""

