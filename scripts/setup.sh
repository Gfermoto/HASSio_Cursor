#!/bin/bash
# ะฃััะฐะฝะพะฒะบะฐ ะฒัะตั ะทะฐะฒะธัะธะผะพััะตะน ะดะปั ัะฐะฑะพัั ั Home Assistant

# ะะฟัะตะดะตะปะธัั ะบะพัะตะฝั ะฟัะพะตะบัะฐ
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
echo "ะัะพะตะบั: $PROJECT_ROOT"
echo ""

# 1. ะกะธััะตะผะฝัะต ะฟะฐะบะตัั
echo "1๏ธโฃ ะกะธััะตะผะฝัะต ะฟะฐะบะตัั..."
sudo apt update
sudo apt install -y openssh-client cifs-utils git netcat-openbsd

# 2. Python ะฟะฐะบะตัั (ั ะพะฑัะพะดะพะผ ะทะฐัะธัั ัะธััะตะผั)
echo ""
echo "2๏ธโฃ Python ะฟะฐะบะตัั..."
pip3 install --user --break-system-packages yamllint pyyaml requests 2>/dev/null || \
    pip3 install --user yamllint pyyaml requests

# 3. ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน
echo ""
echo "3๏ธโฃ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน..."
sudo mkdir -p /mnt/hassio
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# 4. SSH ะบะปัั (ะปะพะบะฐะปัะฝะพ ะฒ ะฟัะพะตะบัะต)
echo ""
echo "4๏ธโฃ SSH ะบะปัั..."
SSH_KEY="$PROJECT_ROOT/.ssh/id_hassio"

mkdir -p "$PROJECT_ROOT/.ssh"
chmod 700 "$PROJECT_ROOT/.ssh"

if [ ! -f "$SSH_KEY" ]; then
    ssh-keygen -t ed25519 -f "$SSH_KEY" -N "" -C "hassio-cursor"
    echo ""
    echo "โ SSH ะบะปัั ัะพะทะดะฐะฝ ะฒ ะฟัะพะตะบัะต!"
else
    echo "โ SSH ะบะปัั ัะถะต ัััะตััะฒัะตั"
fi

chmod 600 "$SSH_KEY"
chmod 644 "${SSH_KEY}.pub"

# 5. ะัะฐะฒะฐ ะฝะฐ ัะบัะธะฟัั
echo ""
echo "5๏ธโฃ ะัะฐะฒะฐ ะฝะฐ ัะบัะธะฟัั..."
cd /home/gfer/HASSio/scripts
chmod +x *.sh

echo ""
echo "======================================================"
echo "โ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะตััะตะฝะฐ!"
echo "======================================================"
echo ""
echo "๐ ะะะจ SSH ะะะฎะง (ัะบะพะฟะธััะนัะต ะฟะพะปะฝะพัััั):"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
cat "${SSH_KEY}.pub"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ ะกะปะตะดัััะธะน ัะฐะณ:"
echo "   1. ะกะบะพะฟะธััะนัะต ะบะปัั ะฒััะต"
echo "   2. ะัะบัะพะนัะต: docs/SETUP.md"
echo "   3. ะะฐัะฝะธัะต ั ัะฐะณะฐ 2 (ัััะฐะฝะพะฒะบะฐ SSH add-on)"
echo ""
